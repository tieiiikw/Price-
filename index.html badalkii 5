<!DOCTYPE html>
<html lang="so">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BSC Wallet â€” Laam</title>

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>


  <!-- QRCode.js (browser-side QR generator) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- CryptoJS for encryption -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

  <style>
  /* ===== VARIABLES ===== */
  :root {
    --primary: #4a6cf7;
    --primary-dark: #3a5ce5;
    --primary-light: #f0f4ff;
    --secondary: #6c5ce7;
    --success: #00b894;
    --danger: #ff7675;
    --warning: #fdcb6e;
    --dark: #2d3436;
    --light: #f8f9fa;
    --gray: #636e72;
    --gray-light: #dfe6e9;
    --white: #ffffff;
    --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
    --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.12);
    --radius: 16px;
    --radius-sm: 8px;
    --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  }

  /* ===== RESET & BASE STYLES ===== */
  * { 
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
  background: radial-gradient(circle at center, #004e64, #00a5a5, #9fffe0);
}
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  margin: 0;
  padding: 0;
}

  
  
    /* ===== CONTAINER ===== */
  .container {
    width: 100%;
    max-width: 440px;
    background: var(--white);
    border-radius: var(--radius);
    box-shadow: var(--shadow-lg);
    overflow: hidden;
    position: relative;
  }
  

#pinSetupModal {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.6);
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

#pinSetupModal.active {
  display: flex;
}
    /* Screen Management */
    .screen{padding:30px;display:none}
    .screen.active{display:block}
    #newTokenAddress {
  transition: border-color 0.3s;
}
#tokenStatusIcon {
  transition: color 0.3s ease;
}
    /* Typography */
    h3{text-align:center;margin-bottom:25px;color:#333;font-size:24px;font-weight:600}
    h4{margin:0 0 8px 0;color:#333}
    label{display:block;margin:15px 0 8px;color:#555;font-weight:500}
    .muted{color:#666;font-size:13px}
    
    /* Form Elements */
    textarea,input{width:100%;padding:12px 15px;border:2px solid #ddd;border-radius:10px;font-size:16px;transition:all 0.3s;resize:none}
    textarea:focus,input:focus{border-color:#4a6cf7;outline:none;box-shadow:0 0 0 3px rgba(74,108,247,0.2)}
    
    /* Buttons */
    button{padding:14px;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;transition:all 0.3s;margin-top:10px;width:100%}
    .small-btn{padding:6px 10px;font-size:14px;border-radius:6px;width:auto}
    .btn-ghost{background:#f4f6fb;color:#333}
    .secondary{background:#f0f4ff;color:#333;border:1px solid #dbe6ff}
    .danger{background:#ff6b6b}
    .green{background:#28a745}
    
    /* Import/Create Screen Specific */
    .import-wallet-btn{background:#4a6cf7;color:white}
    .import-wallet-btn:hover{background:#3a5ce5;transform:translateY(-2px)}
    
    .import-wallet-divider{text-align:center;margin:20px 0;color:#777;font-weight:500;position:relative}
    .import-wallet-divider::before{content:"";position:absolute;top:50%;left:0;width:42%;height:1px;background:#ddd}
    .import-wallet-divider::after{content:"";position:absolute;top:50%;right:0;width:42%;height:1px;background:#ddd}
    
    .create-new-wallet-btn{background:#f8f9fa;color:#333;border:2px solid #ddd}
    .create-new-wallet-btn:hover{background:#e9ecef;transform:translateY(-2px)}
    
    /* Account Generated Screen */
    .success-animation{text-align:center;margin-bottom:20px}
    .success-animation i{font-size:50px;color:#28a745;animation:pulse 1.5s infinite}
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    .key-display{background:#f8f9fa;border:2px solid #ddd;border-radius:10px;padding:15px;margin:15px 0;position:relative}
    .key-title{font-size:14px;color:#777;margin-bottom:8px}
    .key-value{font-family:monospace;font-size:18px;font-weight:bold;color:#333;word-break:break-all}
    .copy-btn{position:absolute;top:15px;right:15px;background:#4a6cf7;color:white;width:auto;padding:8px 12px;font-size:14px;border-radius:6px}
    .copy-btn:hover{background:#3a5ce5}
    
    .warning-box{background:#fff3cd;border:1px solid #ffeaa7;border-radius:10px;padding:15px;margin:20px 0;color:#856404}
    .warning-box h4{margin-bottom:8px;font-size:16px}
    
    .use-account-btn{background:#28a745;color:white;margin-top:20px}
    .use-account-btn:hover{background:#218838;transform:translateY(-2px)}
    
    .back-btn{background:transparent;color:#4a6cf7;border:2px solid #4a6cf7;margin-top:15px}
    .back-btn:hover{background:#f0f4ff}

    /* Lock Screen Styles */
    .lock-screen {
      padding: 30px;
      text-align: center;
    }
.token-selector {
  position: relative;
  display: inline-block;
  width: 100px;
}

.token-selector-btn {
  padding: 8px 12px;
  border: 2px solid #ddd;
  border-radius: 8px;
  background: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 100%;
  font-weight: 600;
}

.token-selector-btn:hover {
  border-color: #4a6cf7;
}

.token-dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 1px solid #ddd;
  border-radius: 8px;
  max-height: 200px;
  overflow-y: auto;
  z-index: 1000;
  display: none;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.token-dropdown.active {
  display: block;
}

.token-option {
  padding: 8px 12px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  border-bottom: 1px solid #f0f0f0;
}

.token-option:hover {
  background: #f0f4ff;
}

.token-option:last-child {
  border-bottom: none;
}

.token-logo {
  width: 20px;
  height: 20px;
  border-radius: 50%;
}

.token-symbol {
  font-weight: 600;
  font-size: 14px;
}

.token-name {
  font-size: 12px;
  color: #666;
}

.swap-input {
  background: #f8f9fa;
  padding: 15px;
  border-radius: 12px;
  margin-bottom: 10px;
}

.input-with-selector {
  display: flex;
  gap: 10px;
  align-items: center;
}

.amount-input {
  flex: 1;
  padding: 12px;
  border: 2px solid #ddd;
  border-radius: 8px;
  font-size: 16px;
  background: white;
}

.amount-input:focus {
  border-color: #4a6cf7;
  outline: none;
}

.swap-arrow {
  text-align: center;
  margin: 10px 0;
}

.swap-arrow-btn {
  background: #f0f4ff;
  border: none;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  cursor: pointer;
  color: #4a6cf7;
  font-size: 16px;
  transition: all 0.3s;
}

.swap-arrow-btn:hover {
  background: #4a6cf7;
  color: white;
  transform: rotate(180deg);
}

   /* ===== BOTTOM NAVIGATION ===== */
  .bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--white);
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: 14px 0;
    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.08);
    border-top: 1px solid var(--gray-light);
    z-index: 1000;
    backdrop-filter: blur(10px);
  }

  .nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: 8px 16px;
    border-radius: 12px;
    cursor: pointer;
    transition: var(--transition);
    color: var(--gray);
    font-size: 12px;
    font-weight: 500;
  }

  .nav-item.active {
    color: var(--primary);
    background: var(--primary-light);
    transform: translateY(-4px);
  }

  .nav-item i {
    font-size: 20px;
    margin-bottom: 2px;
  }

  .nav-item span {
    font-size: 11px;
    font-weight: 600;
  }

#iframeContainer iframe {
    width: 100%;
    height: 100%;
    border: none;
    border-radius: 12px;
}

#homeNavigation,
.bottom-nav,
.trade-sub-nav {
  display: none;       /* hide default */
  visibility: hide;  /* hide */
           /* fade hidden */
}
  /* ===== TRADE SUB NAVIGATION ===== */
  .trade-sub-nav {
    position: fixed;
    bottom: 70px;
    left: 0;
    right: 0;
    background: var(--white);
    display: flex;
    padding: 16px;
    gap: 10px;
    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.08);
    border-top: 1px solid var(--gray-light);
    z-index: 999;
    backdrop-filter: blur(10px);
  }

  .trade-btn {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    padding: 14px 8px;
    border: 2px solid var(--gray-light);
    border-radius: 12px;
    background: var(--light);
    cursor: pointer;
    transition: var(--transition);
    color: var(--gray);
    font-size: 12px;
    font-weight: 500;
  }

  .trade-btn.active {
    border-color: var(--primary);
    background: var(--primary-light);
    color: var(--primary);
    transform: translateY(-4px);
    box-shadow: 0 4px 12px rgba(74, 108, 247, 0.2);
  }

  .trade-btn i {
    font-size: 18px;
  }

  .trade-btn span {
    font-size: 11px;
    font-weight: 600;
  }

    .pin-inputs {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 20px 0;
    }
    
    .pin-digit {
      width: 50px;
      height: 50px;
      text-align: center;
      font-size: 24px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-weight: bold;
      transition: all 0.3s;
    }
    
    .pin-digit:focus {
      border-color: #4a6cf7;
      outline: none;
      transform: scale(1.05);
    }
    
    .pin-digit.filled {
      border-color: #28a745;
      background-color: #f8fff9;
    }
    
    .lock-btn {
      background: #4a6cf7;
      color: white;
      margin-top: 15px;
    }
    
    .lock-btn:hover {
      background: #3a5ce5;
    }
    
    .lock-header {
      margin-bottom: 30px;
    }

    /* PIN Setup Modal Styles */
    .pin-setup-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .pin-setup-modal.active {
      display: flex;
    }

    .pin-setup-card {
      background: white;
      padding: 30px;
      border-radius: 20px;
      width: 90%;
      max-width: 400px;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .pin-setup-header {
      margin-bottom: 25px;
    }

    .pin-setup-header i {
      font-size: 48px;
      color: #4a6cf7;
      margin-bottom: 15px;
      display: block;
    }

    .pin-setup-title {
      font-size: 22px;
      font-weight: 700;
      color: #333;
      margin-bottom: 8px;
    }

    .pin-setup-subtitle {
      color: #666;
      font-size: 15px;
      line-height: 1.4;
    }

    .pin-setup-inputs {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin: 25px 0;
    }

    .pin-setup-digit {
      width: 44px;
      height: 44px;
      text-align: center;
      font-size: 20px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-weight: bold;
      transition: all 0.3s;
      background: #fafafa;
    }

    .pin-setup-digit:focus {
      border-color: #4a6cf7;
      background: white;
      outline: none;
      transform: scale(1.1);
    }

    .pin-setup-digit.filled {
      border-color: #28a745;
      background: #f0fff4;
    }

    .pin-setup-actions {
      display: flex;
      gap: 10px;
      margin-top: 25px;
    }

    .pin-setup-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .pin-setup-cancel {
      background: #f8f9fa;
      color: #666;
      border: 2px solid #e0e0e0;
    }

    .pin-setup-cancel:hover {
      background: #e9ecef;
    }

    .pin-setup-confirm {
      background: #4a6cf7;
      color: white;
    }

    .pin-setup-confirm:hover {
      background: #3a5ce5;
      transform: translateY(-2px);
    }

    .pin-setup-confirm:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .pin-setup-step {
      font-size: 13px;
      color: #4a6cf7;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .pin-setup-hint {
      font-size: 12px;
      color: #888;
      margin-top: 8px;
      min-height: 18px;
    }

    /* Confirmation Modal Styles */
    .confirm-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1001;
    }

    .confirm-modal.active {
      display: flex;
    }

    .confirm-modal-card {
      background: white;
      padding: 30px;
      border-radius: 20px;
      width: 90%;
      max-width: 400px;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      animation: slideUp 0.3s ease-out;
    }

    .confirm-modal-header {
      margin-bottom: 25px;
    }

    .confirm-modal-icon {
      font-size: 60px;
      margin-bottom: 20px;
      display: block;
    }

    .warning-icon {
      color: #ff6b6b;
    }

    .lock-icon {
      color: #4a6cf7;
    }

    .confirm-modal-title {
      font-size: 24px;
      font-weight: 700;
      color: #333;
      margin-bottom: 15px;
    }

    .confirm-modal-message {
      color: #666;
      font-size: 16px;
      line-height: 1.6;
    }

    .confirm-modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 30px;
    }

    .confirm-modal-btn {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .confirm-modal-cancel {
      background: #f8f9fa;
      color: #666;
      border: 2px solid #e0e0e0;
    }

    .confirm-modal-cancel:hover {
      background: #e9ecef;
      transform: translateY(-2px);
    }

    .confirm-modal-confirm {
      background: #ff6b6b;
      color: white;
    }

    .confirm-modal-confirm:hover {
      background: #e55a5a;
      transform: translateY(-2px);
    }

    .lock-confirm-btn {
      background: #4a6cf7;
    }

    .lock-confirm-btn:hover {
      background: #3a5ce5;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-8px); }
      75% { transform: translateX(8px); }
    }

    .shake {
      animation: shake 0.4s ease-in-out;
    }
    
   
  /* ===== DASHBOARD ===== */
  .dashboard-container {
    width: 100%;
    max-width: 480px;
    background: var(--white);
    border-radius: var(--radius);
    overflow: hidden;
    display: none;
    flex-direction: column;
    margin: 0 auto;
    box-shadow: var(--shadow-lg);
  }

  .dashboard-container.active {
    display: flex;
  }

  .wallet-box {
    background: var(--light);
    padding: 24px;
    border-radius: var(--radius-sm);
    margin-bottom: 20px;
    box-shadow: var(--shadow);
  }

  .wallet-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .wallet-info {
    text-align: center;
    flex: 1;
  }

  .wallet-address {
    font-family: monospace;
    font-weight: 700;
    font-size: 14px;
    margin-top: 8px;
    color: var(--primary);
    background: var(--primary-light);
    padding: 6px 12px;
    border-radius: 20px;
    display: inline-block;
  }

  .balance-section {
    text-align: center;
    margin: 24px 0;
  }

  .balance-amount {
    font-size: 32px;
    font-weight: 800;
    color: var(--dark);
    margin: 8px 0;
  }

  .balance-usd {
    color: var(--gray);
    font-size: 16px;
  }

  .actions {
    display: flex;
    justify-content: space-between;
    gap: 12px;
  }

  /* ===== ASSETS LIST ===== */
  .assets-list {
    max-height: 400px;
    overflow-y: auto;
    padding-right: 8px;
  }

  .assets-list::-webkit-scrollbar {
    width: 6px;
  }

  .assets-list::-webkit-scrollbar-track {
    background: var(--light);
    border-radius: 10px;
  }

  .assets-list::-webkit-scrollbar-thumb {
    background: var(--gray-light);
    border-radius: 10px;
  }

  .asset-item {
    display: flex;
    align-items: center;
    padding: 16px;
    border-bottom: 1px solid var(--gray-light);
    transition: var(--transition);
    position: relative;
    cursor: pointer;
    border-radius: var(--radius-sm);
    margin-bottom: 8px;
  }

  .asset-item:hover {
    background: var(--primary-light);
    transform: translateY(-2px);
    box-shadow: var(--shadow);
  }

  .asset-icon-wrapper {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--gradient);
    border-radius: 50%;
    font-weight: bold;
    font-size: 16px;
    margin-right: 16px;
    flex-shrink: 0;
    color: var(--white);
  }

  .asset-logo {
    width: 40px;
    height: 40px;
    border-radius: 50%;
  }

  .asset-details {
    flex: 1;
  }

  .asset-name {
    font-weight: 600;
    color: var(--dark);
    font-size: 16px;
  }

  .asset-symbol {
    font-size: 13px;
    color: var(--gray);
  }

  .asset-balance {
    text-align: right;
    margin-left: 12px;
  }

  .asset-amount {
    font-weight: 700;
    color: var(--dark);
    font-size: 16px;
  }

  .asset-value {
    font-size: 13px;
    color: var(--gray);
  }

  /* ===== MODALS ===== */
  .modal {
    position: fixed;
    inset: 0;
    display: none;
    background: rgba(0, 0, 0, 0.7);
    z-index: 999;
    align-items: center;
    justify-content: center;
    padding: 20px;
    backdrop-filter: blur(5px);
  }

  .modal.active {
    display: flex;
    animation: fadeIn 0.3s ease-out;
  }

  .modal-card {
    background: var(--white);
    padding: 28px;
    border-radius: var(--radius);
    width: 100%;
    max-width: 480px;
    box-shadow: var(--shadow-lg);
    animation: slideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }

  @keyframes slideUp {
    from { opacity: 0; transform: translateY(30px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }
    .wizard-steps {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .step {
      padding: 8px 12px;
      border-radius: 8px;
      background: #f4f6fb;
      font-size: 14px;
    }

    .step.active {
      background: #4a6cf7;
      color: #fff;
    }

    .tx-loading {
      opacity: .9;
      padding: 10px;
      border-radius: 8px;
      background: #fff8e6;
      color: #856404;
    }

    .transactions-list {
      max-height: 160px;
      overflow: auto;
    }

    .hint {
      font-size: 13px;
      color: #666;
      margin-top: 6px;
    }

    .wallet-box .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .wallet-box .row input#newTokenAddress {
      flex: 1;
      min-width: 150px;
    }

    .wallet-box .row input#newTokenSymbol {
      width: 80px;
    }

    .wallet-box .row input#newTokenDecimals {
      width: 60px;
    }

    .wallet-box .row button#addTokenBtn {
      flex-shrink: 0;
    }

    /* Mobile-specific adjustments */
    @media (max-width: 480px) {
      .wallet-box .row input#newTokenAddress {
        width: 100%;
      }
      .wallet-box .row input#newTokenSymbol,
      .wallet-box .row input#newTokenDecimals,
      .wallet-box .row button#addTokenBtn {
        width: 48%;
        margin-top: 5px;
      }

.pin-setup-digit {
        width: 40px;
        height: 40px;
        font-size: 18px;
      }
    }

  </style>
</head>
<body>
  <!-- PIN Setup Modal -->
  <div class="pin-setup-modal" id="pinSetupModal">
    <div class="pin-setup-card">
      <div class="pin-setup-header">
        <i class="fas fa-shield-alt"></i>
        <div class="pin-setup-title">Set Up Wallet Security</div>
        <div class="pin-setup-subtitle">Create a 6-digit PIN to secure your wallet</div>
      </div>

      <div id="pinSetupStep1">
        <div class="pin-setup-step">STEP 1: CREATE YOUR PIN</div>
        <div class="pin-setup-inputs">
          <input type="password" class="pin-setup-digit" maxlength="1" data-index="0" inputmode="numeric">
          <input type="password" class="pin-setup-digit" maxlength="1" data-index="1" inputmode="numeric">
          <input type="password" class="pin-setup-digit" maxlength="1" data-index="2" inputmode="numeric">
          <input type="password" class="pin-setup-digit" maxlength="1" data-index="3" inputmode="numeric">
          <input type="password" class="pin-setup-digit" maxlength="1" data-index="4" inputmode="numeric">
          <input type="password" class="pin-setup-digit" maxlength="1" data-index="5" inputmode="numeric">
        </div>
        <div class="pin-setup-hint" id="pinHint1">Enter 6 digits for your PIN</div>
      </div>

      <div id="pinSetupStep2" style="display: none;">
        <div class="pin-setup-step">STEP 2: CONFIRM YOUR PIN</div>
        <div class="pin-setup-inputs">
          <input type="password" class="pin-setup-digit" maxlength="1" data-index="0" inputmode="numeric">
          <input type="password" class="pin-setup-digit" maxlength="1" data-index="1" inputmode="numeric">
          <input type="password" class="pin-setup-digit" maxlength="1" data-index="2" inputmode="numeric">
          <input type="password" class="pin-setup-digit" maxlength="1" data-index="3" inputmode="numeric">
          <input type="password" class="pin-setup-digit" maxlength="1" data-index="4" inputmode="numeric">
          <input type="password" class="pin-setup-digit" maxlength="1" data-index="5" inputmode="numeric">
        </div>
        <div class="pin-setup-hint" id="pinHint2">Re-enter your PIN to confirm</div>
      </div>

      <div class="pin-setup-actions">
        <button id="pinSetupCancel" class="pin-setup-btn pin-setup-cancel">Cancel</button>
        <button id="pinSetupConfirm" class="pin-setup-btn pin-setup-confirm" disabled>Continue</button>
      </div>
    </div>
  </div>

  <!-- Forgot PIN Confirmation Modal -->
  <div class="confirm-modal" id="forgotPinModal">
    <div class="confirm-modal-card">
      <div class="confirm-modal-header">
        <i class="fas fa-exclamation-triangle confirm-modal-icon warning-icon"></i>
        <div class="confirm-modal-title">Forgot PIN?</div>
        <div class="confirm-modal-message">
          Haddii aad illowdo PIN-ka, waxaad waayi doontaa access-ka wallet-ka.<br>
          <strong>Ma rabtaa inaad bilowdo mid cusub?</strong>
        </div>
      </div>
      <div class="confirm-modal-actions">
        <button id="forgotPinCancel" class="confirm-modal-btn confirm-modal-cancel">Cancel</button>
        <button id="forgotPinConfirm" class="confirm-modal-btn confirm-modal-confirm">Yes, Start Over</button>
      </div>
    </div>
  </div>

  <!-- Lock Wallet Confirmation Modal -->
  <div class="confirm-modal" id="lockWalletModal">
    <div class="confirm-modal-card">
      <div class="confirm-modal-header">
        <i class="fas fa-lock confirm-modal-icon lock-icon"></i>
        <div class="confirm-modal-title">Lock Wallet?</div>
        <div class="confirm-modal-message">
          Ma hubtaa inaad xidhayso wallet-ka?<br>
          Waa inaad geli doontaa PIN-ka mar kale si aad u furto.
        </div>
      </div>
      <div class="confirm-modal-actions">
        <button id="lockWalletCancel" class="confirm-modal-btn confirm-modal-cancel">Cancel</button>
        <button id="lockWalletConfirm" class="confirm-modal-btn confirm-modal-confirm lock-confirm-btn">Yes, Lock</button>
      </div>
    </div>
  </div>

  <!-- Lock Screen -->
  <div class="container">
    <div class="screen" id="lockScreen">
      <div class="lock-screen">
        <div class="lock-header">
          <i class="fas fa-lock" style="font-size: 48px; color: #4a6cf7; margin-bottom: 20px;"></i>
          <h3>Laam Wallet Locked</h3>
          <p class="muted">Enter your PIN to unlock</p>
        </div>
        
        <div class="pin-inputs">
          <input type="password" class="pin-digit" maxlength="1" data-index="0" inputmode="numeric">
          <input type="password" class="pin-digit" maxlength="1" data-index="1" inputmode="numeric">
          <input type="password" class="pin-digit" maxlength="1" data-index="2" inputmode="numeric">
          <input type="password" class="pin-digit" maxlength="1" data-index="3" inputmode="numeric">
          <input type="password" class="pin-digit" maxlength="1" data-index="4" inputmode="numeric">
          <input type="password" class="pin-digit" maxlength="1" data-index="5" inputmode="numeric">
        </div>
        
        <button id="unlockWalletBtn" class="lock-btn">
          <i class="fas fa-unlock"></i> Unlock Wallet
        </button>
        
        <div style="margin-top: 20px;">
          <button id="forgotPinBtn" class="small-btn btn-ghost">
            Forgot PIN?
          </button>
        </div>
      </div>
    </div>


    <!-- Import/Create Wallet Screen -->
    <div class="screen" id="importWalletScreen">
      <h3><i class="fas fa-key"></i> Import or Create BSC Wallet</h3>
      <label>Private Key:</label>
      <textarea id="privateKeyInput" placeholder="Enter your private key starting with 0x..." rows="3"></textarea>
      <button id="importWalletBtn" class="import-wallet-btn">
        <i class="fas fa-download"></i> Import Wallet and Save
      </button>
      <div class="import-wallet-divider">or</div>
      <button id="createNewWalletBtn" class="create-new-wallet-btn">
        <i class="fas fa-plus-circle"></i> Create New Wallet
      </button>
    </div>

    <div class="screen" id="accountGeneratedScreen">
      <div class="success-animation">
        <i class="fas fa-check-circle"></i>
      </div>
      <h3>BSC Wallet Created</h3>
      <div class="key-display">
        <div class="key-title">Private Key (Keep Secret!)</div>
        <div class="key-value" id="secretKeyDisplay">Your private key will appear here</div>
        <button class="copy-btn" id="copySecretKeyBtn"><i class="fas fa-copy"></i> COPY</button>
      </div>
      <div class="key-display">
        <div class="key-title">Wallet Address</div>
        <div class="key-value" id="publicKeyDisplay">Your wallet address will appear here</div>
        <button class="copy-btn" id="copyPublicKeyBtn"><i class="fas fa-copy"></i> COPY</button>
      </div>
      <div class="warning-box">
        <h4><i class="fas fa-exclamation-triangle"></i> IMPORTANT</h4>
        <p>Save your Private Key in a secure place!</p>
      </div>
      <button id="useAccountBtn" class="use-account-btn">
        <i class="fas fa-wallet"></i> USE THIS WALLET
      </button>
      <button id="backToImportBtn" class="back-btn">
        <i class="fas fa-arrow-left"></i> Back to Import
      </button>
    </div>
  </div>

  <!-- Main Wallet Dashboard -->
  <div class="dashboard-container" id="mainDashboard">
    <!-- LEFT: Wallet controls -->
    <div class="col" id="leftCol">
      <div class="wallet-header">
        <div class="wallet-info">
          <h3><i class="fas fa-wallet"></i> Laam Wallet (Mainnet)</h3>
          <div class="wallet-address" id="walletAddress">â€”</div>
          <button id="copyAddressBtn" class="small-btn" style="margin-top: 5px;">
            <i class="fas fa-copy"></i> Copy
          </button>
        </div>
        <button id="lockWalletBtn" class="small-btn btn-ghost">
          <i class="fas fa-lock"></i> Lock
        </button>
      </div>

      <!-- Current Wallet Info -->
      <div class="wallet-box">
        <div class="balance-section">
          <div class="muted">Total Balance</div>
          <div class="balance-amount" id="totalBalance">0 BNB</div>
          <div class="balance-usd" id="balanceUSD">$0</div>
        </div>
        <div class="actions">
          <button id="sendBtnWallet" class="small-btn">
            <i class="fas fa-paper-plane"></i> Send
          </button>
          <button id="receiveBtnWallet" class="small-btn secondary">
            <i class="fas fa-qrcode"></i> Receive
          </button>
        </div>
      </div>
    </div>

    <!-- RIGHT: Assets & Transactions -->
    <div class="col" id="rightCol">
      <h3>Assets</h3>
      <div id="assetsList" class="assets-list">
        <div class="muted">Loading...</div>
      </div>

      <div class="wallet-box">
        <label>Ku dar Token (BEP20)</label>
        <div class="row">
          <input id="newTokenAddress" placeholder="Contract address" />
          <input id="newTokenSymbol" placeholder="SYMB" />
          <input id="newTokenDecimals" placeholder="dec" />
          <button id="addTokenBtn" class="small-btn">Add token</button>
        </div>
      </div>

      <!-- Transactions history -->
      <div class="wallet-box">
        <h4 style="margin:0 0 8px 0">Transaction History (local)</h4>
        <div class="transactions-list" id="transactionsList">
          <div class="muted small">Wax wax ma jiraan weli â€” markaad dirto/hesho ayaa halkaan lagu soo bandhigi doonaa.</div>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="clearHistoryBtn" class="small-btn btn-ghost">Clear</button>
          <button id="refreshBalancesBtn" class="small-btn">Refresh</button>
        </div>
      </div>
    </div>
  </div>
<!-- HOME NAVIGATION -->
<div class="container" id="homeNavigation">
    <div class="app-btn" onclick="openInApp('https://wallet.laam.online')">
        <i class="fas fa-wallet"></i><br>Wallet
    </div>

    <div class="app-btn" onclick="openInApp('https://p2p.laam.online')">
        ðŸ’±<br>P2P
    </div>

    <div class="app-btn" onclick="openInApp('https://whitepaper.laam.online')">
        ðŸ“œ<br>Whitepaper
    </div>
</div>

<!-- Iframe container for in-app browsing -->
<div id="iframeContainer" style="display:none; width:100%; height:calc(100vh - 80px); margin-top:10px; border-radius:12px; overflow:hidden;"></div>
<!-- Bottom Navigation Bar -->
<div class="bottom-nav" id="bottomNav">
  <div class="nav-item active" data-tab="home">
    <i class="fas fa-home"></i>
    <span>Home</span>
  </div>
  <div class="nav-item" data-tab="trade">
    <i class="fas fa-exchange-alt"></i>
    <span>Trade</span>
  </div>
  <div class="nav-item" data-tab="wallet">
    <i class="fas fa-wallet"></i>
    <span>Wallet</span>
  </div>
</div>


<!-- Trade Sub Navigation -->
<div class="trade-sub-nav" id="tradeSubNav" style="display: none;">
  <button class="trade-btn active" data-type="swap">
    <i class="fas fa-sync-alt"></i>
    <span>Swap</span>
  </button>
  <button class="trade-btn" data-type="limit">
    <i class="fas fa-chart-line"></i>
    <span>Limit</span>
  </button>
  <button class="trade-btn" data-type="perps">
    <i class="fas fa-rocket"></i>
    <span>Perps</span>
  </button>
</div>

<!-- Trade Screen Container -->
<div id="tradeScreenContainer"></div>



  <!-- SEND Modal (3-step wizard UI) -->
  <div id="sendModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h4 style="margin:0">Send â€” 3 Tallaabo</h4>
        <button id="closeSendModal" class="small-btn btn-ghost">X</button>
      </div>

      <div style="margin-top:12px">
        <div class="wizard-steps">
          <div class="step active" data-step="1">1 Amount</div>
          <div class="step" data-step="2">2 Recipient</div>
          <div class="step" data-step="3">3 Confirm</div>
        </div>

        <!-- Step 1 -->
        <div id="step1" class="step-panel">
          <label>Qadarka</label>
          <input id="sendAmount" placeholder="0.00" />
          <div style="margin-top:8px;display:flex;gap:8px">
            <div class="row" style="gap:8px;align-items:center">
              <button class="small-btn btn-ghost quick-amount" data-amount="0.001">0.001</button>
              <button class="small-btn btn-ghost quick-amount" data-amount="0.01">0.01</button>
              <button class="small-btn btn-ghost quick-amount" data-amount="0.1">0.1</button>
            </div>

            <select id="sendCurrency" style="margin-left:auto;padding:6px;border-radius:8px">
              <option value="BNB">BNB</option>
            </select>
          </div>

          <div class="hint" style="margin-top:8px">Available: <span id="availableBalance">0 BNB</span></div>

          <div style="margin-top:12px;display:flex;gap:8px">
            <button id="cancelSendBtn" class="small-btn btn-ghost">Cancel</button>
            <button id="step1Next" class="small-btn">Next</button>
          </div>
        </div>

        <!-- Step 2 -->
        <div id="step2" class="step-panel" style="display:none;margin-top:10px">
          <label>Recipient Address</label>
          <input id="recipientAddress" placeholder="0x..." />
          <div class="hint">Geli address-ka BSC ee qofka aad lacagta u dirayso.</div>

          <div style="margin-top:12px;display:flex;gap:8px">
            <button id="step2Back" class="small-btn btn-ghost">Back</button>
            <button id="step2Next" class="small-btn">Next</button>
          </div>
        </div>

        <!-- Step 3 -->
        <div id="step3" class="step-panel" style="display:none;margin-top:10px">
          <h4>Xaqiiji</h4>
          <div style="margin-top:8px">
            <div class="asset-item">
              <div>Amount</div>
              <div id="confirmAmount">0 BNB</div>
            </div>
            <div class="asset-item">
              <div>To</div>
              <div id="confirmAddress" style="font-family:monospace">â€”</div>
            </div>
            <div class="asset-item">
              <div>Fee (est)</div>
              <div id="confirmFee">estimating...</div>
            </div>
            <div style="margin-top:8px" id="txNotice" class="muted small"></div>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px">
            <button id="step3Back" class="small-btn btn-ghost">Back</button>
            <button id="confirmSendBtn" class="small-btn green">Confirm & Send</button>
          </div>

          <div id="sendProgress" style="margin-top:10px"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- RECEIVE Modal -->
  <div id="receiveModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h4 style="margin:0">Receive â€” QR & Address</h4>
        <button id="closeReceiveModal" class="small-btn btn-ghost">X</button>
      </div>

      <div style="margin-top:12px">
        <div style="display:flex;gap:12px;align-items:center">
          <div id="qrcode" style="width:160px;height:160px;background:#fff;padding:8px;border-radius:8px"></div>
          <div style="flex:1">
            <div class="muted">Your address</div>
            <div id="receiveAddress" style="font-family:monospace;font-weight:800;margin-top:6px">â€”</div>
            <div style="margin-top:12px" class="actions">
              <button id="copyReceiveAddr" class="small-btn">Copy</button>
              <button id="downloadQR" class="small-btn btn-ghost">Download QR</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ========== Global iyo Init ========== */
let web3;
const BSC_RPC = "https://bsc-dataseed.binance.org/"; // Mainnet
const tokenABI = [
  // balanceOf, decimals, symbol, transfer
  {"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"type":"function"},
  {"constant":true,"inputs":[],"name":"decimals","outputs":[{"name":"","type":"uint8"}],"type":"function"},
  {"constant":true,"inputs":[],"name":"symbol","outputs":[{"name":"","type":"string"}],"type":"function"},
  {"constant":false,"inputs":[{"name":"_to","type":"address"},{"name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"name":"","type":"bool"}],"type":"function"}
];

 
// Encryption key for PIN
const ENCRYPTION_KEY = "laam_wallet_secure_key";

// Current session state
let currentPrivateKey = null;
let currentAddress = null;
let tokens = JSON.parse(localStorage.getItem("laam_tokens_v1") || "[]");
const MORALIS_API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJub25jZSI6IjQ5OWY0OWE4LWFjMzUtNDk0ZS05OTE2LWU3OGExNzVmODg1NSIsIm9yZ0lkIjoiNDgxMjQ4IiwidXNlcklkIjoiNDk1MTA5IiwidHlwZUlkIjoiNDAzODFmMWQtM2E3Zi00Yzg4LTlmYjEtZjhhOGZhMTcxNGRiIiwidHlwZSI6IlBST0pFQ1QiLCJpYXQiOjE3NjMwNzg3OTgsImV4cCI6NDkxODgzODc5OH0.lFiCbJnV8ADu7ACI4D5YBvOr6G0NhQ1QXD5RwYnlQ7c";


// Auto refresh control
let autoRefreshEnabled = false;

// PIN Setup State
let pinSetupStep = 1;
let firstPIN = '';

/* Initialize web3 provider */
function initWeb3() {
  try {
    web3 = new Web3(new Web3.providers.HttpProvider(BSC_RPC));
    console.log("Web3 ready (BSC mainnet)");
  } catch(e) {
    console.error("Web3 init error:", e);
    alert("Error initializing Web3. Check console.");
  }
}
initWeb3();

/* ====== DOM Refs ====== */
// Confirmation Modal elements
const forgotPinModal = document.getElementById('forgotPinModal');
const forgotPinCancel = document.getElementById('forgotPinCancel');
const forgotPinConfirm = document.getElementById('forgotPinConfirm');
const lockWalletModal = document.getElementById('lockWalletModal');
const lockWalletCancel = document.getElementById('lockWalletCancel');
const lockWalletConfirm = document.getElementById('lockWalletConfirm');

/* ===== Navigation Refs ===== */
const homeNavigation = document.getElementById('homeNavigation');
const bottomNav = document.querySelector('.bottom-nav');
const tradeSubNav = document.querySelector('.trade-sub-nav');

// PIN Setup Modal elements
const pinSetupModal = document.getElementById('pinSetupModal');
const pinSetupStep1 = document.getElementById('pinSetupStep1');
const pinSetupStep2 = document.getElementById('pinSetupStep2');
const pinSetupDigits1 = pinSetupStep1.querySelectorAll('.pin-setup-digit');
const pinSetupDigits2 = pinSetupStep2.querySelectorAll('.pin-setup-digit');
const pinHint1 = document.getElementById('pinHint1');
const pinHint2 = document.getElementById('pinHint2');
const pinSetupCancel = document.getElementById('pinSetupCancel');
const pinSetupConfirm = document.getElementById('pinSetupConfirm');

// Lock screen elements
const lockScreen = document.getElementById('lockScreen');
const pinDigits = document.querySelectorAll('.pin-digit');
const unlockWalletBtn = document.getElementById('unlockWalletBtn');
const forgotPinBtn = document.getElementById('forgotPinBtn');
const lockWalletBtn = document.getElementById('lockWalletBtn');

// Intro screens
const importWalletScreen = document.getElementById('importWalletScreen');
const accountGeneratedScreen = document.getElementById('accountGeneratedScreen');
const mainDashboard = document.getElementById('mainDashboard');

// Import/Create screen elements
const privateKeyInput = document.getElementById('privateKeyInput');
const importWalletBtn = document.getElementById('importWalletBtn');
const createNewWalletBtn = document.getElementById('createNewWalletBtn');

// Account generated screen elements
const secretKeyDisplay = document.getElementById('secretKeyDisplay');
const publicKeyDisplay = document.getElementById('publicKeyDisplay');
const copySecretKeyBtn = document.getElementById('copySecretKeyBtn');
const copyPublicKeyBtn = document.getElementById('copyPublicKeyBtn');
const useAccountBtn = document.getElementById('useAccountBtn');
const backToImportBtn = document.getElementById('backToImportBtn');

// Dashboard elements
const walletAddressEl = document.getElementById('walletAddress');
const totalBalanceEl = document.getElementById('totalBalance');
const balanceUSDEl = document.getElementById('balanceUSD');
const assetsListEl = document.getElementById('assetsList');
const addTokenBtn = document.getElementById('addTokenBtn');
const newTokenAddress = document.getElementById('newTokenAddress');
const newTokenSymbol = document.getElementById('newTokenSymbol');
const newTokenDecimals = document.getElementById('newTokenDecimals');
const copyAddressBtn = document.getElementById('copyAddressBtn');

/* Send modal refs */
const sendModal = document.getElementById('sendModal');
const sendBtnWallet = document.getElementById('sendBtnWallet');
const closeSendModal = document.getElementById('closeSendModal');
const receiveBtnWallet = document.getElementById('receiveBtnWallet');
const receiveModal = document.getElementById('receiveModal');
const closeReceiveModal = document.getElementById('closeReceiveModal');
const qrcodeDiv = document.getElementById('qrcode');
const receiveAddressEl = document.getElementById('receiveAddress');
const copyReceiveAddr = document.getElementById('copyReceiveAddr');
const downloadQR = document.getElementById('downloadQR');

/* Wizard elements */
const stepPanels = {1: document.getElementById('step1'), 2: document.getElementById('step2'), 3: document.getElementById('step3')};
const stepButtons = { next1: document.getElementById('step1Next'), next2: document.getElementById('step2Next'),
                      back2: document.getElementById('step2Back'), back3: document.getElementById('step3Back'),
                      cancelSendBtn: document.getElementById('cancelSendBtn'), confirmSendBtn: document.getElementById('confirmSendBtn')
                    };
const sendAmountInput = document.getElementById('sendAmount');
const sendCurrencySelect = document.getElementById('sendCurrency');
const recipientAddressInput = document.getElementById('recipientAddress');
const availableBalanceEl = document.getElementById('availableBalance');
const confirmAmountEl = document.getElementById('confirmAmount');
const confirmAddressEl = document.getElementById('confirmAddress');
const confirmFeeEl = document.getElementById('confirmFee');
const sendProgressEl = document.getElementById('sendProgress');
const txNoticeEl = document.getElementById('txNotice');
const transactionsListEl = document.getElementById('transactionsList');
const clearHistoryBtn = document.getElementById('clearHistoryBtn');
const refreshBalancesBtn = document.getElementById('refreshBalancesBtn');

const fromAmount = document.getElementById('fromAmount');
  const toAmount = document.getElementById('toAmount');
  const fromSelector = document.getElementById('fromSelector');
  const toSelector = document.getElementById('toSelector');
  const getQuoteBtn = document.getElementById('getQuoteBtn');
  const swapBtn = document.getElementById('swapBtn');
  const tradeStatus = document.getElementById('tradeStatus');
  const slippageInput = document.getElementById('slippage');

const PANCAKESWAP_ROUTER_ABI = [
  "function swapExactETHForTokens(uint amountOutMin, address[] calldata path, address to, uint deadline) external payable returns (uint[] memory amounts)",
];

/* ========== Confirmation Modal Functions ========== */
function openForgotPinModal() {
  forgotPinModal.classList.add('active');
}

function closeForgotPinModal() {
  forgotPinModal.classList.remove('active');
}

function openLockWalletModal() {
  lockWalletModal.classList.add('active');
}

function closeLockWalletModal() {
  lockWalletModal.classList.remove('active');
}

/* ========== Event Listeners for Confirmation Modals ========== */
// Forgot PIN events
forgotPinBtn.addEventListener('click', () => {
  openForgotPinModal();
});

forgotPinCancel.addEventListener('click', () => {
  closeForgotPinModal();
});

forgotPinConfirm.addEventListener('click', () => {
  // Clear all wallet data
  localStorage.removeItem("laam_encrypted_priv");
  localStorage.removeItem("laam_wallet_address");
  localStorage.removeItem("laam_pin_set");
  localStorage.removeItem("laam_tokens_v1");
  localStorage.removeItem("laam_tx_history");
  
  // Clear session data
  sessionStorage.removeItem("laam_unlocked_priv");
  sessionStorage.removeItem("laam_unlocked_addr");
  sessionStorage.removeItem("temp_private_key");
  sessionStorage.removeItem("temp_address");
  
  // Reset state
  currentPrivateKey = null;
  currentAddress = null;
  tokens = [];
  
  closeForgotPinModal();
  showScreen('import');
  
  // Show success message
  setTimeout(() => {
    alert('ðŸ”“ Wallet reset successfully. You can now create a new wallet.');
  }, 300);
});

// Lock Wallet events
lockWalletBtn.addEventListener('click', () => {
  openLockWalletModal();
});

lockWalletCancel.addEventListener('click', () => {
  closeLockWalletModal();
});

lockWalletConfirm.addEventListener('click', () => {
  lockWallet();
  closeLockWalletModal();
});

/* ========== PIN Setup Functions ========== */
function openPinSetupModal() {
  pinSetupModal.classList.add('active');
  resetPinSetup();
  pinSetupDigits1[0].focus();
}

function closePinSetupModal() {
  pinSetupModal.classList.remove('active');
  resetPinSetup();
}

function resetPinSetup() {
  pinSetupStep = 1;
  firstPIN = '';
  
  // Clear all inputs
  pinSetupDigits1.forEach(digit => {
    digit.value = '';
    digit.classList.remove('filled');
  });
  pinSetupDigits2.forEach(digit => {
    digit.value = '';
    digit.classList.remove('filled');
  });
  
  // Reset UI
  pinSetupStep1.style.display = 'block';
  pinSetupStep2.style.display = 'none';
  pinSetupConfirm.disabled = true;
  pinSetupConfirm.textContent = 'Continue';
  pinHint1.textContent = 'Enter 6 digits for your PIN';
  pinHint1.style.color = '#888';
  pinHint2.textContent = 'Re-enter your PIN to confirm';
  pinHint2.style.color = '#888';
}

function setupPinInputListeners(digits, step) {
  digits.forEach((digit, index) => {
    digit.addEventListener('input', (e) => {
      const value = e.target.value;
      
      if (value && /^\d$/.test(value)) {
        digit.classList.add('filled');
        
        // Move to next input
        if (index < digits.length - 1) {
          digits[index + 1].focus();
        }
      } else {
        digit.classList.remove('filled');
      }
      
      // Check if all digits are filled
      checkPinComplete(digits, step);
    });
    
    digit.addEventListener('keydown', (e) => {
      if (e.key === 'Backspace' && !e.target.value && index > 0) {
        digits[index - 1].focus();
        digits[index - 1].value = '';
        digits[index - 1].classList.remove('filled');
        checkPinComplete(digits, step);
      }
    });
  });
}

function checkPinComplete(digits, step) {
  const pin = Array.from(digits).map(d => d.value).join('');
  const isComplete = pin.length === 6;
  
  if (step === 1) {
    pinSetupConfirm.disabled = !isComplete;
    pinHint1.textContent = isComplete ? 'âœ“ PIN entered' : 'Enter 6 digits for your PIN';
    pinHint1.style.color = isComplete ? '#28a745' : '#888';
  } else {
    pinSetupConfirm.disabled = !isComplete;
    pinHint2.textContent = isComplete ? 'âœ“ PIN confirmed' : 'Re-enter your PIN to confirm';
    pinHint2.style.color = isComplete ? '#28a745' : '#888';
  }
  
  return isComplete;
}

function getPinFromDigits(digits) {
  return Array.from(digits).map(d => d.value).join('');
}

// Initialize PIN setup listeners
setupPinInputListeners(pinSetupDigits1, 1);
setupPinInputListeners(pinSetupDigits2, 2);

/* PIN Setup Event Handlers */
pinSetupConfirm.addEventListener('click', () => {
  console.log("PIN Setup Confirm clicked, step:", pinSetupStep);
  
  if (pinSetupStep === 1) {
    // Step 1: Save first PIN and move to confirmation
    firstPIN = getPinFromDigits(pinSetupDigits1);
    console.log("First PIN:", firstPIN);
    
    if (firstPIN.length === 6) {
      // Move to step 2
      pinSetupStep1.style.display = 'none';
      pinSetupStep2.style.display = 'block';
      pinSetupStep = 2;
      pinSetupConfirm.disabled = true;
      pinSetupConfirm.textContent = 'Finish Setup';
      pinSetupDigits2[0].focus();
    }
  } else {
    // Step 2: Confirm PIN and finish setup
    const secondPIN = getPinFromDigits(pinSetupDigits2);
    console.log("Second PIN:", secondPIN);
    
    if (secondPIN.length === 6) {
      if (firstPIN === secondPIN) {
        // PINs match - complete setup
        const tempPriv = sessionStorage.getItem("temp_private_key");
        const tempAddr = sessionStorage.getItem("temp_address");
        
        console.log("Temp wallet data:", { tempAddr, tempPriv: tempPriv ? 'exists' : 'missing' });
        
        if (tempPriv && tempAddr) {
          saveEncryptedWallet(tempAddr, tempPriv, firstPIN);
          setCurrentWallet(tempAddr, tempPriv);
          closePinSetupModal();
          showScreen('dashboard');
          
          // Clear temporary storage
          sessionStorage.removeItem("temp_private_key");
          sessionStorage.removeItem("temp_address");
          
          console.log("Wallet setup completed successfully");
          
          // Success notification
          setTimeout(() => {
            alert('ðŸŽ‰ Wallet successfully secured with PIN!');
          }, 500);
        } else {
          alert('Error: Wallet data not found. Please try again.');
          closePinSetupModal();
          showScreen('import');
        }
      } else {
        // PINs don't match
        pinHint2.textContent = 'PINs do not match. Try again.';
        pinHint2.style.color = '#dc3545';
        
        // Clear second PIN and reset
        pinSetupDigits2.forEach(digit => {
          digit.value = '';
          digit.classList.remove('filled');
        });
        pinSetupConfirm.disabled = true;
        pinSetupDigits2[0].focus();
      }
    }
  }
});

pinSetupCancel.addEventListener('click', () => {
  console.log("PIN Setup cancelled");
  closePinSetupModal();
});

/* ========== Encryption Functions ========== */
function encryptData(data, pin) {
  const key = CryptoJS.PBKDF2(pin, ENCRYPTION_KEY, { keySize: 256/32, iterations: 1000 });
  const encrypted = CryptoJS.AES.encrypt(data, key.toString(), { mode: CryptoJS.mode.CBC });
  return encrypted.toString();
}

function decryptData(encryptedData, pin) {
  try {
    const key = CryptoJS.PBKDF2(pin, ENCRYPTION_KEY, { keySize: 256/32, iterations: 1000 });
    const decrypted = CryptoJS.AES.decrypt(encryptedData, key.toString(), { mode: CryptoJS.mode.CBC });
    return decrypted.toString(CryptoJS.enc.Utf8);
  } catch(e) {
    return null;
  }
}

function saveEncryptedWallet(address, privateKey, pin) {
  const encryptedKey = encryptData(privateKey, pin);
  localStorage.setItem("laam_encrypted_priv", encryptedKey);
  localStorage.setItem("laam_wallet_address", address);
  localStorage.setItem("laam_pin_set", "true");
}

function loadEncryptedWallet(pin) {
  const encryptedKey = localStorage.getItem("laam_encrypted_priv");
  const address = localStorage.getItem("laam_wallet_address");
  
  if (!encryptedKey || !address) return null;
  
  const decryptedKey = decryptData(encryptedKey, pin);
  if (!decryptedKey) return null;
  
  return { address, privateKey: decryptedKey };
}
/* ========== PIN Input Management ========== */
pinDigits.forEach((digit, index) => {
  digit.addEventListener('input', (e) => {
    // Move to next input automatically
    if (e.target.value && index < pinDigits.length - 1) {
      pinDigits[index + 1].focus();
    }
  });
  
  digit.addEventListener('keydown', (e) => {
    // Handle backspace
    if (e.key === 'Backspace' && !e.target.value && index > 0) {
      pinDigits[index - 1].focus();
    }
  });
});

function getPin() {
  return Array.from(pinDigits).map(d => d.value).join('');
}

function clearPin() {
  pinDigits.forEach(d => d.value = '');
  pinDigits[0].focus();
}

/* ========== Screen Management ========== */
function showScreen(screenName) {
  importWalletScreen.classList.remove('active');
  accountGeneratedScreen.classList.remove('active');
  mainDashboard.classList.remove('active');
  lockScreen.classList.remove('active');
  
  switch(screenName) {
    case 'import':
      importWalletScreen.classList.add('active');
      break;
    case 'account':
      accountGeneratedScreen.classList.add('active');
      break;
    case 'dashboard':
      mainDashboard.classList.add('active');
      updateWalletUI();
      break;
    case 'lock':
      lockScreen.classList.add('active');
      clearPin();
      break;
  }
}

/* ========== Lock/Unlock Functions ========== */
function lockWallet() {
  stopAutoRefresh();
  currentPrivateKey = null;
  currentAddress = null;
  sessionStorage.removeItem("laam_unlocked_priv");
  sessionStorage.removeItem("laam_unlocked_addr");

  // ðŸ”¥ Navigation OFF
  homeNavigation.style.display = "none";
  bottomNav.style.display = "none";
  tradeSubNav.style.display = "none";

  showScreen('lock');
}
function unlockWallet(pin) {
  const wallet = loadEncryptedWallet(pin);
  if (wallet) {
    setCurrentWallet(wallet.address, wallet.privateKey);

    // ðŸ”¥ Navigation ON
    document.getElementById("homeNavigation").style.display = "flex";
    document.querySelector(".bottom-nav").style.display = "flex";
    document.querySelector(".trade-sub-nav").style.display = "flex";

    showScreen('dashboard');
    return true;
  }
  return false;
}

/* ========== Auto Refresh Functions ========== */
async function autoRefreshLoop() {
    while (autoRefreshEnabled && currentAddress) {
        console.log("âŸ³ Auto refreshing wallet...");
        await updateWalletUI();
        await new Promise(r => setTimeout(r, 30000)); // 30 seconds
    }
}

function startAutoRefresh() {
    autoRefreshEnabled = true;
    autoRefreshLoop();
}

function stopAutoRefresh() {
    autoRefreshEnabled = false;
}

/* ========== Wallet State Management ========== */
function setCurrentWallet(addr, priv) {
  currentAddress = addr;
  currentPrivateKey = priv;
  if (addr) sessionStorage.setItem("laam_unlocked_addr", addr);
  if (priv) sessionStorage.setItem("laam_unlocked_priv", priv);
  
  // Start auto refresh when wallet is set
  if (addr && priv) {
    startAutoRefresh();
  }
}

/* ========== Event Listeners ========== */
// Lock/Unlock events
unlockWalletBtn.addEventListener('click', () => {
  const pin = getPin();
  if (pin.length !== 6) {
    alert('Fadlan geli PIN-ka oo dhan 6 xaraf');
    return;
  }
  
  if (unlockWallet(pin)) {
    clearPin();
  } else {
    alert('PIN-ka waa khalad. Isku day mar kale.');
    clearPin();
  }
});

// Import/Create wallet events
createNewWalletBtn.addEventListener('click', async () => {
  try {
    const acct = web3.eth.accounts.create();
    
    // Display the generated account
    secretKeyDisplay.textContent = acct.privateKey;
    publicKeyDisplay.textContent = acct.address;
    
    // Store temporarily for use when they click "USE THIS WALLET"
    sessionStorage.setItem("temp_private_key", acct.privateKey);
    sessionStorage.setItem("temp_address", acct.address);
    
    showScreen('account');
  } catch(e) {
    console.error("Create wallet error", e);
    alert('Error creating wallet. Eeg console.');
  }
});

importWalletBtn.addEventListener('click', async () => {
  let priv = privateKeyInput.value.trim();
  if (!priv) { alert('Fadlan geli private key'); return; }
  if (!priv.startsWith('0x')) priv = '0x'+priv;
  
  try {
    const acct = web3.eth.accounts.privateKeyToAccount(priv);
    
    // Display the imported account
    secretKeyDisplay.textContent = acct.privateKey;
    publicKeyDisplay.textContent = acct.address;
    
    // Store temporarily for use when they click "USE THIS WALLET"
    sessionStorage.setItem("temp_private_key", acct.privateKey);
    sessionStorage.setItem("temp_address", acct.address);
    
    showScreen('account');
    privateKeyInput.value = '';
  } catch(e) {
    console.error("Import error", e);
    alert('Private key-ga waa saxna waa khalad. Fadlan hubi.');
  }
});

// Account generated screen events - MODIFIED to use PIN setup modal
useAccountBtn.addEventListener('click', () => {
  const tempPriv = sessionStorage.getItem("temp_private_key");
  const tempAddr = sessionStorage.getItem("temp_address");
  
  if (tempPriv && tempAddr) {
    // Open PIN setup modal instead of using prompt
    openPinSetupModal();
  }
});

backToImportBtn.addEventListener('click', () => {
  showScreen('import');
});

/* Copy button functionality */
copySecretKeyBtn.addEventListener('click', async () => {
  try { 
    await navigator.clipboard.writeText(secretKeyDisplay.textContent); 
    copySecretKeyBtn.innerHTML = '<i class="fas fa-check"></i> COPIED';
    setTimeout(() => {
      copySecretKeyBtn.innerHTML = '<i class="fas fa-copy"></i> COPY';
    }, 2000);
  } catch(e){ 
    alert('Copy failed'); 
  }
});

copyPublicKeyBtn.addEventListener('click', async () => {
  try { 
    await navigator.clipboard.writeText(publicKeyDisplay.textContent); 
    copyPublicKeyBtn.innerHTML = '<i class="fas fa-check"></i> COPIED';
    setTimeout(() => {
      copyPublicKeyBtn.innerHTML = '<i class="fas fa-copy"></i> COPY';
    }, 2000);
  } catch(e){ 
    alert('Copy failed'); 
  }
});

copyAddressBtn.addEventListener('click', async () => {
  if (!currentAddress) return alert('Wallet ma furmin');
  try { 
    await navigator.clipboard.writeText(currentAddress); 
    alert('Address copied'); 
  } catch(e){ 
    alert('Copy failed'); 
  }
});

/* ========== Dashboard Functions ========== */
/* Show wallet info on UI */
async function updateWalletUI() {
    if (!currentAddress) {
        walletAddressEl.innerText = 'â€”';
        totalBalanceEl.innerText = '0.0000 BNB';
        balanceUSDEl.innerText = '$0';
        assetsListEl.innerHTML = '<div class="muted">Wallet ma furmin</div>';
        availableBalanceEl.innerText = '0 BNB';
        return;
    }

    walletAddressEl.innerText = currentAddress;
    receiveAddressEl.innerText = currentAddress;

    // Fetch BNB balance + price
    let bnbBalance = 0;
    let bnbPrice = 0;
    try {
        const balanceWei = await web3.eth.getBalance(currentAddress);
        bnbBalance = parseFloat(web3.utils.fromWei(balanceWei, 'ether'));
        // Fetch BNB price from Coingecko
        try {
            const cgRes = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=binancecoin&vs_currencies=usd`);
            const data = await cgRes.json();
            bnbPrice = data?.binancecoin?.usd || 300;
        } catch(e){
            console.warn('BNB price fetch failed, fallback to $300', e);
            bnbPrice = 300;
        }
        totalBalanceEl.innerText = `${bnbBalance.toFixed(4)} BNB`;
        availableBalanceEl.innerText = `${bnbBalance.toFixed(4)} BNB`;
        balanceUSDEl.innerText = `$${(bnbBalance*bnbPrice).toFixed(2)}`;
    } catch(e){ console.error('BNB balance error', e); }

    // Send currency select
    sendCurrencySelect.innerHTML = '<option value="BNB">BNB</option>';

    tokens = JSON.parse(localStorage.getItem("laam_tokens_v1") || "[]");
    for (let t of tokens) {
        const opt = document.createElement('option');
        opt.value = t.address;
        opt.textContent = `${t.symbol} (${t.symbol})`;
        sendCurrencySelect.appendChild(opt);
    }

    // Render assets
    assetsListEl.innerHTML = '';

    // BNB row
    const bnbLogoURL = 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/smartchain/info/logo.png';
    const bnbRow = document.createElement('div');
    bnbRow.className = 'asset-item';
    bnbRow.innerHTML = `
        <div class="asset-icon-wrapper">
            <img src="${bnbLogoURL}" alt="BNB" class="asset-logo" onerror="this.onerror=null;this.src='BN';">
        </div>
        <div class="asset-details">
            <div class="asset-name">Binance Coin</div>
            <div class="asset-symbol">BNB</div>
        </div>
        <div class="asset-balance">
            <div class="asset-amount" id="bnbAmount">${bnbBalance.toFixed(4)}</div>
            <div class="asset-value" id="bnbValue">$${(bnbBalance*bnbPrice).toFixed(2)}</div>
        </div>
        <div class="asset-actions" style="display:none; margin-top:5px; gap:5px;">
            <button class="small-btn send-btn">Send</button>
            <button class="small-btn receive-btn">Receive</button>
        </div>
    `;
    assetsListEl.appendChild(bnbRow);

    const bnbActions = bnbRow.querySelector('.asset-actions');
    bnbRow.addEventListener('click', e=>{
        if(e.target.classList.contains('send-btn') || e.target.classList.contains('receive-btn')) return;
        bnbActions.style.display = bnbActions.style.display==='flex' ? 'none':'flex';
        bnbActions.style.flexWrap = 'wrap';
    });
    bnbRow.querySelector('.send-btn').addEventListener('click', e=>{
        e.stopPropagation();
        alert('Send BNB');
    });
    bnbRow.querySelector('.receive-btn').addEventListener('click', e=>{
        e.stopPropagation();
        alert('Receive BNB');
    });

    // Tokens
    if(tokens.length===0){
        const div = document.createElement('div');
        div.className = 'muted';
        div.style.padding = '20px';
        div.style.textAlign = 'center';
        div.innerText = 'No tokens added yet.';
        assetsListEl.appendChild(div);
    } else {
        for(let tk of tokens){
            const wrapper = document.createElement('div');
            wrapper.className = 'asset-item';
            wrapper.style.cursor = 'pointer';
            wrapper.innerHTML = `
                <div class="asset-icon-wrapper">
                    <img src="${tk.logo}" alt="${tk.symbol}" class="asset-logo" onerror="this.onerror=null;this.src='${(tk.symbol||'T').substring(0,2)}';">
                </div>
                <div class="asset-details">
                    <div class="asset-name" id="tok-${tk.address}-name">${tk.name||tk.symbol}</div>
                    <div class="asset-symbol">${tk.symbol}</div>
                </div>
                <div class="asset-balance">
                    <div class="asset-amount" id="tok-${tk.address}-bal">loading...</div>
                    <div class="asset-value" id="tok-${tk.address}-val">$-</div>
                </div>
                <div class="asset-actions" style="display:none; margin-top:5px; gap:5px;">
                    <button class="small-btn send-btn">Send</button>
                    <button class="small-btn receive-btn">Receive</button>
                    <button class="small-btn remove-btn">Remove</button>
                </div>
            `;
            assetsListEl.appendChild(wrapper);

            const actions = wrapper.querySelector('.asset-actions');

            wrapper.addEventListener('click', e=>{
                if(['send-btn','receive-btn','remove-btn'].some(c=>e.target.classList.contains(c))) return;
                actions.style.display = actions.style.display==='flex'?'none':'flex';
                actions.style.flexWrap = 'wrap';
            });

            wrapper.querySelector('.send-btn').addEventListener('click', e=>{
                e.stopPropagation();
                alert(`Send ${tk.symbol}`);
            });
            wrapper.querySelector('.receive-btn').addEventListener('click', e=>{
                e.stopPropagation();
                alert(`Receive ${tk.symbol}`);
            });
            wrapper.querySelector('.remove-btn').addEventListener('click', e=>{
                e.stopPropagation();
                if(confirm(`Remove ${tk.symbol}?`)){
                    tokens = tokens.filter(t=>t.address!==tk.address);
                    localStorage.setItem("laam_tokens_v1", JSON.stringify(tokens));
                    updateWalletUI();
                }
            });

            // Fetch balance + price
            (async(token)=>{
                try{
                    const contract = new web3.eth.Contract(tokenABI, token.address);
                    const balRaw = await contract.methods.balanceOf(currentAddress).call();
                    const dec = token.decimals!==undefined ? Number(token.decimals) : await contract.methods.decimals().call();
                    const bal = Number(balRaw)/(10**dec);
                    document.getElementById(`tok-${token.address}-bal`).innerText = bal.toFixed(4);
                    
                    // Price using Moralis
                    let price = 0;
                    try {
                        const res = await fetch(
                            `https://deep-index.moralis.io/api/v2/erc20/${token.address}/price?chain=bsc`,
                            {
                                headers: {
                                    "X-API-Key": MORALIS_API_KEY
                                }
                            }
                        );

                        if (res.ok) {
                            const data = await res.json();
                            price = data.usdPrice || 0;
                        }
                    } catch (err) {
                        console.warn("Moralis price error â†’", err);
                    }
                    
                    const value = bal * price;
                    document.getElementById(`tok-${token.address}-val`).innerText = `$${value.toFixed(2)}`;
                    
                }catch(err){
                    console.error('Token balance error', err);
                    document.getElementById(`tok-${token.address}-bal`).innerText='err';
                }
            })(tk);
        }
    }
}
    
       
/* ====== Add Token (automatic logo with Coingecko/CMC fallback) ====== */
addTokenBtn.addEventListener('click', async () => {
  const addr = (newTokenAddress.value || '').trim();
  let sym = (newTokenSymbol.value || '').trim();
  let dec = (newTokenDecimals.value || '').trim();

  if (!web3.utils.isAddress(addr)) { alert('Addresska token-ka ma saxna'); return; }

  // Haddii symbol ama decimals madhan â†’ fetch automatic
  if (!sym || !dec) {
      try {
          const contract = new web3.eth.Contract(tokenABI, addr);
          sym = sym || await contract.methods.symbol().call();
          dec = dec || await contract.methods.decimals().call();
      } catch(err) {
          console.error("Error fetching token info:", err);
          alert('Failed to fetch token info');
          return;
      }
  }

  dec = Number(dec);

  tokens = JSON.parse(localStorage.getItem("laam_tokens_v1") || "[]");
  if (tokens.some(t => t.address.toLowerCase() === addr.toLowerCase())) {
    alert('Token-kan hore ayaa lagu daray.');
    return;
  }

  // Automatic logo URL (TrustWallet convention)
  let logo = `https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/smartchain/assets/${addr}/logo.png`;

  // Fallback: Coingecko API
  try {
      const cgRes = await fetch(`https://api.coingecko.com/api/v3/coins/binance-smart-chain/contract/${addr.toLowerCase()}`);
      if (cgRes.ok) {
          const cgData = await cgRes.json();
          if (cgData.image && cgData.image.small) {
              logo = cgData.image.small; // override if available
          }
      }
  } catch(e) {
      console.warn("CoinGecko logo fetch failed:", e);
  }

  tokens.push({ address: addr, symbol: sym, decimals: dec, name: sym, logo });
  localStorage.setItem("laam_tokens_v1", JSON.stringify(tokens));

  // Clear inputs
  newTokenAddress.value = newTokenSymbol.value = newTokenDecimals.value = '';
  await updateWalletUI();
});

// Auto-fill symbol & decimals marka address la galiyo
newTokenAddress.addEventListener('blur', async () => {
    const address = newTokenAddress.value.trim();
    if (!web3.utils.isAddress(address)) {
        newTokenSymbol.value = '';
        newTokenDecimals.value = '';
        return;
    }

    try {
        const contract = new web3.eth.Contract(tokenABI, address);
        const [symbol, decimals] = await Promise.all([
            contract.methods.symbol().call(),
            contract.methods.decimals().call()
        ]);
        newTokenSymbol.value = symbol;
        newTokenDecimals.value = decimals;
    } catch (err) {
        console.error("Error fetching token info:", err);
        newTokenSymbol.value = '';
        newTokenDecimals.value = '';
    }
});

/* ========== Send modal logic (wizard) ========== */
sendBtnWallet.addEventListener('click', () => {
  if (!currentAddress) { alert('Fadlan marka hore fur wallet (create/import)'); return; }
  openSendModal();
});

function openSendModal() {
  document.querySelectorAll('.step').forEach((el,i)=>el.classList.toggle('active', i===0));
  Object.values(stepPanels).forEach(p => p.style.display='none');
  stepPanels[1].style.display='block';
  sendModal.classList.add('active');
  sendProgressEl.innerHTML = '';
  txNoticeEl.innerText = '';
}

closeSendModal.addEventListener('click', ()=> sendModal.classList.remove('active'));
cancelSendBtn.addEventListener('click', ()=> sendModal.classList.remove('active'));

/* wizard navigation */
stepButtons.next1.addEventListener('click', () => {
  const amt = sendAmountInput.value.trim();
  if (!amt || isNaN(amt) || Number(amt) <= 0) { alert('Geli qadarka saxda ah'); return; }
  stepPanels[1].style.display='none'; stepPanels[2].style.display='block';
  setWizardStepActive(2);
});
stepButtons.back2.addEventListener('click', () => {
  stepPanels[2].style.display='none'; stepPanels[1].style.display='block';
  setWizardStepActive(1);
});
stepButtons.next2.addEventListener('click', () => {
  const addr = recipientAddressInput.value.trim();
  if (!web3.utils.isAddress(addr)) { alert('Recipient address ma saxna'); return; }
  const cur = sendCurrencySelect.value;
  const amt = Number(sendAmountInput.value);
  confirmAmountEl.innerText = `${amt} ${ cur === 'BNB' ? 'BNB' : tokens.find(t=>t.address===cur)?.symbol || 'TOKEN'}`;
  confirmAddressEl.innerText = addr;
  estimateFeePreview(cur, amt, addr);
  stepPanels[2].style.display='none'; stepPanels[3].style.display='block';
  setWizardStepActive(3);
});
stepButtons.back3.addEventListener('click', () => {
  stepPanels[3].style.display='none'; stepPanels[2].style.display='block';
  setWizardStepActive(2);
});

/* confirm send */
stepButtons.confirmSendBtn.addEventListener('click', async () => {
  const currency = sendCurrencySelect.value;
  const amount = Number(sendAmountInput.value);
  const to = recipientAddressInput.value.trim();
  if (!currentPrivateKey) { alert('Private key ma jiro. Import/create marka hore.'); return; }
  sendProgressEl.innerHTML = '<div class="tx-loading">Sending... please wait</div>';
  try {
    let txHash;
    if (currency === 'BNB') {
      txHash = await sendBNB(currentPrivateKey, to, amount);
      pushTxHistory({ type: 'Send BNB', to, amount, txHash, ts: Date.now() });
    } else {
      const t = tokens.find(tt => tt.address === currency);
      if (!t) throw new Error('Token ma jira');
      txHash = await sendToken(currentPrivateKey, t.address, to, amount, t.decimals);
      pushTxHistory({ type: `Send ${t.symbol}`, to, amount, txHash, ts: Date.now() });
    }
    sendProgressEl.innerHTML = `<div class="muted small">Success! TxHash: <a target="_blank" href="https://bscscan.com/tx/${txHash}">${txHash}</a></div>`;
    await updateWalletUI();
    refreshTxHistoryUI();
  } catch(e) {
    console.error("Send error", e);
    sendProgressEl.innerHTML = `<div class="muted small" style="color:#a00">Error: ${e.message || e}</div>`;
  }
});

/* helper: set wizard step active style */
function setWizardStepActive(step) {
  document.querySelectorAll('.step').forEach((el)=> el.classList.toggle('active', Number(el.dataset.step) === step));
}

/* estimate fee preview */
async function estimateFeePreview(currency, amount, to) {
  try {
    if (currency === 'BNB') {
      const gasPrice = await web3.eth.getGasPrice();
      const gasLimit = 21000;
      const feeBNB = web3.utils.fromWei((BigInt(gasPrice) * BigInt(gasLimit)).toString(), 'ether');
      confirmFeeEl.innerText = `${Number(feeBNB).toFixed(6)} BNB (est)`;
      txNoticeEl.innerText = 'Fee waa qiyaas; waxaa laga yaabaa inuu ka yaraado ama ka bato markii la saxiixo.';
    } else {
      const gasPrice = await web3.eth.getGasPrice();
      const est = 120000;
      const feeBNB = web3.utils.fromWei((BigInt(gasPrice) * BigInt(est)).toString(), 'ether');
      confirmFeeEl.innerText = `${Number(feeBNB).toFixed(6)} BNB (est)`;
      txNoticeEl.innerText = 'Token transfer fee waa qiyaas; tani waxay ku kuxirantahay network-ka.';
    }
  } catch(e){
    console.error("Estimate err", e);
    confirmFeeEl.innerText = 'error';
  }
}

/* Quick amounts */
document.querySelectorAll('.quick-amount').forEach(b => {
  b.addEventListener('click', () => sendAmountInput.value = b.dataset.amount);
});

/* ======== Send BNB (signed tx) ======== */
async function sendBNB(privKey, to, amountBNB) {
  const account = web3.eth.accounts.privateKeyToAccount(privKey);
  const from = account.address;
  const nonce = await web3.eth.getTransactionCount(from, 'pending');
  const value = web3.utils.toWei(amountBNB.toString(), 'ether');
  const gasPrice = await web3.eth.getGasPrice();
  const tx = {
    to,
    value,
    gas: 21000,
    gasPrice,
    nonce,
    chainId: 56
  };
  const signed = await account.signTransaction(tx);
  const receipt = await web3.eth.sendSignedTransaction(signed.rawTransaction);
  return receipt.transactionHash;
}

/* ======== Send Token (ERC20 transfer) ======== */
async function sendToken(privKey, tokenAddress, to, amount, decimals) {
  const account = web3.eth.accounts.privateKeyToAccount(privKey);
  const from = account.address;
  const contract = new web3.eth.Contract(tokenABI, tokenAddress);
  const value = BigInt(Math.floor(amount * (10 ** decimals))).toString();
  const data = contract.methods.transfer(to, value).encodeABI();
  const nonce = await web3.eth.getTransactionCount(from, 'pending');
  const gasPrice = await web3.eth.getGasPrice();
  let gasLimit;
  try {
    gasLimit = await contract.methods.transfer(to, value).estimateGas({from});
    gasLimit = Math.floor(gasLimit * 1.2);
  } catch(e) { gasLimit = 150000; }
  const tx = {
    to: tokenAddress,
    data,
    gas: gasLimit,
    gasPrice,
    nonce,
    value: '0x0',
    chainId: 56
  };
  const signed = await account.signTransaction(tx);
  const receipt = await web3.eth.sendSignedTransaction(signed.rawTransaction);
  return receipt.transactionHash;
}

/* ========== Receive modal: QR generation ========== */
receiveBtnWallet.addEventListener('click', () => {
  if (!currentAddress) { alert('Fadlan fur wallet marka hore'); return; }
  openReceiveModal();
});

function openReceiveModal() {
  qrcodeDiv.innerHTML = '';
  new QRCode(qrcodeDiv, {
    text: currentAddress,
    width: 160,
    height: 160,
    colorDark : "#000000",
    colorLight : "#ffffff",
    correctLevel : QRCode.CorrectLevel.H
  });
  receiveAddressEl.innerText = currentAddress;
  receiveModal.classList.add('active');
}
closeReceiveModal.addEventListener('click', ()=> receiveModal.classList.remove('active'));
copyReceiveAddr.addEventListener('click', async () => {
  try { await navigator.clipboard.writeText(currentAddress); alert('Address copied'); } catch(e){ alert('Copy failed'); }
});
downloadQR.addEventListener('click', () => {
  const svg = qrcodeDiv.querySelector('img') || qrcodeDiv.querySelector('canvas');
  if (!svg) {
    alert('QR not available');
    return;
  }
  if (svg.tagName.toLowerCase() === 'img') {
    const src = svg.src;
    const a = document.createElement('a');
    a.href = src;
    a.download = `${currentAddress}.png`;
    a.click();
  } else {
    const data = svg.toDataURL('image/png');
    const a = document.createElement('a');
    a.href = data;
    a.download = `${currentAddress}.png`;
    a.click();
  }
});
/* ========== Transaction History Functions ========== */
function pushTxHistory(item) {
  const arr = JSON.parse(localStorage.getItem('laam_tx_history') || '[]');
  arr.unshift(item);
  localStorage.setItem('laam_tx_history', JSON.stringify(arr.slice(0,200)));
  refreshTxHistoryUI();
}

function refreshTxHistoryUI() {
  const arr = JSON.parse(localStorage.getItem('laam_tx_history') || '[]');
  if (arr.length === 0) {
    transactionsListEl.innerHTML = '<div class="muted small">No transactions yet</div>';
    return;
  }
  transactionsListEl.innerHTML = '';
  for (let it of arr) {
    const d = new Date(it.ts);
    const el = document.createElement('div');
    el.className = 'asset-item';
    el.innerHTML = `<div><strong>${it.type}</strong><div class="muted small">to ${it.to}</div></div><div style="text-align:right"><div class="small">${d.toLocaleString()}</div><div><a target="_blank" href="https://bscscan.com/tx/${it.txHash}">${shortHash(it.txHash)}</a></div></div>`;
    transactionsListEl.appendChild(el);
  }
}

function shortHash(h) { return h ? h.substring(0,10)+'...' : '-'; }

// Ku dar event listeners-ka cusub
clearHistoryBtn.addEventListener('click', ()=> { 
  if (confirm('Clear history?')) { 
    localStorage.removeItem('laam_tx_history'); 
    refreshTxHistoryUI(); 
  }
});

refreshBalancesBtn.addEventListener('click', updateWalletUI);

/* ========== On Load Logic ========== */
window.addEventListener('load', async () => {
  tokens = JSON.parse(localStorage.getItem("laam_tokens_v1") || "[]");
  
  // Check if wallet exists in localStorage
  const hasEncryptedWallet = localStorage.getItem("laam_encrypted_priv") && 
                            localStorage.getItem("laam_wallet_address");
  
  if (hasEncryptedWallet) {
    showScreen('lock');
  } else {
    showScreen('import');
  }
  
  refreshTxHistoryUI();
});

// --- Spinner helper ---
function setTokenStatusIcon(state){
  let icon = document.getElementById("tokenStatusIcon");
  if(!icon){
    icon = document.createElement("span");
    icon.id = "tokenStatusIcon";
    icon.style.marginLeft = "8px";
    icon.style.fontSize = "1.1rem";
    newTokenAddress.parentNode.insertBefore(icon, newTokenAddress.nextSibling);
  }
  if(state === "loading"){
    icon.textContent = "â³";
    icon.style.color = "goldenrod";
  } else if(state === "success"){
    icon.textContent = "âœ…";
    icon.style.color = "limegreen";
  } else if(state === "failed"){
    icon.textContent = "âŒ";
    icon.style.color = "crimson";
  } else {
    icon.textContent = "";
  }
}


/* ========== Bottom Navigation Functions ========== */
function initBottomNavigation() {
  const navItems = document.querySelectorAll('.nav-item');
  const tradeSubNav = document.getElementById('tradeSubNav');
  const tradeBtns = document.querySelectorAll('.trade-btn');
  
  // Main navigation click handlers
  navItems.forEach(item => {
    item.addEventListener('click', () => {
      const tab = item.dataset.tab;
      
      // Remove active class from all items
      navItems.forEach(nav => nav.classList.remove('active'));
      
      // Add active class to clicked item
      item.classList.add('active');
      
      // Handle tab switching
      switch(tab) {
        case 'home':
          document.getElementById('mainDashboard').style.display = 'none';
          tradeSubNav.style.display = 'none';
          document.querySelectorAll('.trade-screen').forEach(screen => {
            screen.style.display = 'none';
          });
          document.getElementById('homeNavigation').style.display = 'grid';
          break;
        case 'trade':
          tradeSubNav.style.display = 'flex';
          document.getElementById('homeNavigation').style.display = 'none';
          document.getElementById('mainDashboard').style.display = 'none';
          showTradeScreen();
          break;
        case 'wallet':
          document.getElementById('homeNavigation').style.display = 'none';
          document.getElementById('mainDashboard').style.display = 'flex';
          tradeSubNav.style.display = 'none';
          break;
      }
    });
  });
  
  // Trade sub-navigation click handlers
  tradeBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      // Remove active class from all trade buttons
      tradeBtns.forEach(b => b.classList.remove('active'));
      
      // Add active class to clicked button
      btn.classList.add('active');
      
      const tradeType = btn.dataset.type;
      switchTradeType(tradeType);
    });
  });
}

function showTradeScreen() {
  // Hide main dashboard
  document.getElementById('mainDashboard').style.display = 'none';
  
  // Show trade screen
  let tradeScreen = document.getElementById('tradeScreen');
  if (!tradeScreen) {
    createTradeScreen();
  } else {
    tradeScreen.style.display = 'block';
  }
}

function switchTradeType(type) {
  console.log(`Switching to trade type: ${type}`);
  
  // Update the trade screen based on type
  const tradeScreen = document.getElementById('tradeScreen');
  if (tradeScreen) {
    const title = tradeScreen.querySelector('h3');
    if (title) {
      switch(type) {
        case 'swap':
          title.innerHTML = '<i class="fas fa-sync-alt"></i> Swap Tokens';
          break;
        case 'limit':
          title.innerHTML = '<i class="fas fa-chart-line"></i> Limit Order';
          break;
        case 'perps':
          title.innerHTML = '<i class="fas fa-rocket"></i> Perpetuals';
          break;
      }
    }
  }
}

/* ---------------------- REAL SWAP FUNCTIONALITY ---------------------- */
function createTradeScreen() {
  const existing = document.getElementById('tradeScreen');
  if (existing) existing.remove();

  const tradeScreen = document.createElement('div');
  tradeScreen.id = 'tradeScreen';
  tradeScreen.className = 'trade-screen';
  tradeScreen.innerHTML = `
    
      <div class="wallet-box">
       
          <!-- FROM Section -->
          <div class="swap-input">
            <label>Sell</label>
            <div class="input-with-selector">
              <input type="number" placeholder="0.0" id="fromAmount" class="amount-input" min="0" step="any">
              <div class="token-selector">
                <button class="token-selector-btn" id="fromTokenBtn">
                  <span id="fromTokenSymbol">BNB</span>
                  <i class="fas fa-chevron-down"></i>
                </button>
                <div class="token-dropdown" id="fromTokenDropdown"></div>
              </div>
                </div>
            <div class="balance-info">Balance: <span id="fromBalance">0.0000</span> <span id="fromBalanceSymbol">BNB</span></div>
          </div>
          <!-- Swap Arrow -->
          <div class="swap-arrow">
            <button class="swap-arrow-btn" id="swapTokensBtn">
              <i class="fas fa-arrow-down"></i>
            </button>
          </div>

          <!-- TO Section -->
          <div class="swap-input">
            <label>Buy</label>
            <div class="input-with-selector">
              <input type="text" placeholder="0.0" id="toAmount" class="amount-input" readonly>
              <div class="token-selector">
                <button class="token-selector-btn" id="toTokenBtn">
                  <span id="toTokenSymbol">USDT</span>
                  <i class="fas fa-chevron-down"></i>
                </button>
                <div class="token-dropdown" id="toTokenDropdown"></div>
              </div>
            </div>
            <div class="balance-info">Balance: <span id="toBalance">0.0000</span> <span id="toBalanceSymbol">USDT</span></div>
          </div>

          <!-- Settings -->
          <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
            <label style="font-size:12px">Slippage (%)</label>
            <input id="slippageInput" type="number" value="2" min="0.5" max="20" step="0.1" style="width:80px;padding:6px;border-radius:6px;border:1px solid #ddd">
          </div>

          <!-- Swap Button -->
          <div style="margin-top:12px">
            <button class="swap-btn" id="swapBtn"><i class="fas fa-sync-alt"></i> Swap</button>
          </div>

          <div id="swapStatus" style="margin-top:10px;color:#444;font-size:13px"></div>
        </div>
      </div>
    </div>
  `;

  document.body.appendChild(tradeScreen);

  // Initialize token selectors
  initTokenSelectors();
  
  // --- Rest of your existing trade code with modifications ---
  const fromAmountInput = document.getElementById('fromAmount');
  const toAmountInput = document.getElementById('toAmount');
  const slippageInput = document.getElementById('slippageInput');
  const swapBtn = document.getElementById('swapBtn');
  const statusDiv = document.getElementById('swapStatus');
  const fromBalanceEl = document.getElementById('fromBalance');
  const toBalanceEl = document.getElementById('toBalance');
  const swapTokensBtn = document.getElementById('swapTokensBtn');

  // Current selected tokens
  let fromToken = { symbol: 'BNB', address: 'BNB', decimals: 18 };
  let toToken = { symbol: 'USDT', address: '0x55d398326f99059fF775485246999027B3197955', decimals: 18 };

  // Update token displays
  function updateTokenDisplays() {
    document.getElementById('fromTokenSymbol').textContent = fromToken.symbol;
    document.getElementById('toTokenSymbol').textContent = toToken.symbol;
    document.getElementById('fromBalanceSymbol').textContent = fromToken.symbol;
    document.getElementById('toBalanceSymbol').textContent = toToken.symbol;
    
    // Update swap button text
    swapBtn.innerHTML = `<i class="fas fa-sync-alt"></i> Swap ${fromToken.symbol} â†’ ${toToken.symbol}`;
    
    // Update balances
    updateBalances();
  }

  // Swap tokens button
  swapTokensBtn.addEventListener('click', () => {
    // Swap from and to tokens
    const temp = fromToken;
    fromToken = toToken;
    toToken = temp;
    
    // Also swap amounts
    const tempAmount = fromAmountInput.value;
    fromAmountInput.value = toAmountInput.value;
    toAmountInput.value = tempAmount;
    
    updateTokenDisplays();
    estimateOutput(); // Re-estimate after swap
  });

  // Ku bedel function-ka initTokenSelectors
function initTokenSelectors() {
    const fromBtn = document.getElementById('fromTokenBtn');
    const toBtn = document.getElementById('toTokenBtn');
    const fromDropdown = document.getElementById('fromTokenDropdown');
    const toDropdown = document.getElementById('toTokenDropdown');

    // Common tokens for BSC
    const commonTokens = [
        { symbol: 'BNB', address: 'BNB', decimals: 18, name: 'Binance Coin', logo: 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/smartchain/info/logo.png' },
        { symbol: 'USDT', address: '0x55d398326f99059fF775485246999027B3197955', decimals: 18, name: 'Tether USD' },
        { symbol: 'BUSD', address: '0xe9e7CEA3Dedca5984780Bafc599bD69adD087D56', decimals: 18, name: 'Binance USD' },
        { symbol: 'USDC', address: '0x8AC76a51cc950d9822D68b83fE1Ad97B32Cd580d', decimals: 18, name: 'USD Coin' },
        { symbol: 'CAKE', address: '0x0E09FaBB73Bd3Ade0a17ECC321fD13a19e81cE82', decimals: 18, name: 'PancakeSwap' }
    ];

    // Add user's custom tokens
    const allTokens = [...commonTokens, ...tokens];

    function populateDropdown(dropdown, onSelect, isFromToken = true) {
        dropdown.innerHTML = '';
        allTokens.forEach(token => {
            const option = document.createElement('div');
            option.className = 'token-option';
            option.innerHTML = `
                <img src="${token.logo || ''}" alt="${token.symbol}" class="token-logo" onerror="this.style.display='none'">
                <div style="flex: 1;">
                    <div class="token-symbol">${token.symbol}</div>
                    <div class="token-name">${token.name || token.symbol}</div>
                </div>
                <div class="token-balance" id="${isFromToken ? 'from' : 'to'}DropdownBalance-${token.symbol}" style="font-size: 12px; color: #666;">
                    Loading...
                </div>
            `;
            option.addEventListener('click', () => {
                onSelect(token);
                dropdown.classList.remove('active');
            });
            dropdown.appendChild(option);
            
            // Load balance for this token in dropdown
            loadTokenBalanceForDropdown(token, isFromToken);
        });
    }

    // From token selector
    fromBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        toDropdown.classList.remove('active');
        fromDropdown.classList.toggle('active');
        
        // Refresh balances in dropdown when opened
        if (fromDropdown.classList.contains('active')) {
            allTokens.forEach(token => {
                loadTokenBalanceForDropdown(token, true);
            });
        }
    });

    // To token selector
    toBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        fromDropdown.classList.remove('active');
        toDropdown.classList.toggle('active');
        
        // Refresh balances in dropdown when opened
        if (toDropdown.classList.contains('active')) {
            allTokens.forEach(token => {
                loadTokenBalanceForDropdown(token, false);
            });
        }
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', () => {
        fromDropdown.classList.remove('active');
        toDropdown.classList.remove('active');
    });

    // Populate dropdowns
    populateDropdown(fromDropdown, (token) => {
        fromToken = token;
        updateTokenDisplays();
        estimateOutput();
    }, true);

    populateDropdown(toDropdown, (token) => {
        toToken = token;
        updateTokenDisplays();
        estimateOutput();
    }, false);
}

// Ku bedel function-ka loadTokenBalanceForDropdown
async function loadTokenBalanceForDropdown(token, isFromToken = true) {
    if (!currentAddress) return;

    try {
        let balance;
        if (token.symbol === 'BNB') {
            // Isticmaal web3-gaaga hore
            const balanceWei = await web3.eth.getBalance(currentAddress);
            balance = parseFloat(web3.utils.fromWei(balanceWei, 'ether')).toFixed(4);
        } else {
            // Isticmaal web3-gaaga hore
            const contract = new web3.eth.Contract(ERC20_ABI, token.address);
            const balanceWei = await contract.methods.balanceOf(currentAddress).call();
            balance = (balanceWei / (10 ** token.decimals)).toFixed(4);
        }

        const balanceElement = document.getElementById(`${isFromToken ? 'from' : 'to'}DropdownBalance-${token.symbol}`);
        if (balanceElement) {
            balanceElement.textContent = balance;
            balanceElement.style.color = "#666";
            balanceElement.style.fontSize = "12px";
        }
    } catch (error) {
        console.error(`Balance load error for ${token.symbol}:`, error);
        const balanceElement = document.getElementById(`${isFromToken ? 'from' : 'to'}DropdownBalance-${token.symbol}`);
        if (balanceElement) {
            balanceElement.textContent = "Error";
            balanceElement.style.color = "red";
        }
    }
}

// Ku bedel updateBalances function
async function updateBalances() {
    if (!currentAddress) return;

    try {
        // From token balance
        if (fromToken.symbol === 'BNB') {
            const balanceWei = await web3.eth.getBalance(currentAddress);
            fromBalanceEl.textContent = parseFloat(web3.utils.fromWei(balanceWei, 'ether')).toFixed(4);
        } else {
            const contract = new web3.eth.Contract(ERC20_ABI, fromToken.address);
            const balanceWei = await contract.methods.balanceOf(currentAddress).call();
            fromBalanceEl.textContent = (balanceWei / (10 ** fromToken.decimals)).toFixed(4);
        }

        // To token balance
        if (toToken.symbol === 'BNB') {
            const balanceWei = await web3.eth.getBalance(currentAddress);
            toBalanceEl.textContent = parseFloat(web3.utils.fromWei(balanceWei, 'ether')).toFixed(4);
        } else {
            const contract = new web3.eth.Contract(ERC20_ABI, toToken.address);
            const balanceWei = await contract.methods.balanceOf(currentAddress).call();
            toBalanceEl.textContent = (balanceWei / (10 ** toToken.decimals)).toFixed(4);
        }
    } catch (error) {
        console.error("Balance update error:", error);
        fromBalanceEl.textContent = "0.0000";
        toBalanceEl.textContent = "0.0000";
    }
}

// Ku bedel estimation functions si loo isticmaalo web3
async function estimateBNBToToken(amountBNB, tokenAddress) {
    try {
        const router = new web3.eth.Contract(PANCAKESWAP_ROUTER_ABI, PANCAKE_ROUTER);
        
        const amountInWei = web3.utils.toWei(amountBNB.toString(), 'ether');
        const path = [WBNB, tokenAddress];
        
        const amounts = await router.methods.getAmountsOut(amountInWei, path).call();
        const output = amounts[1] / (10 ** 18); // Assuming token has 18 decimals
        
        return output;
    } catch (error) {
        console.error("BNB to Token estimation error:", error);
        throw new Error("Qadarka lagu estimate gareyn karo waa khalad");
    }
}

async function estimateTokenToBNB(amountToken, tokenAddress, tokenDecimals) {
    try {
        const router = new web3.eth.Contract(PANCAKESWAP_ROUTER_ABI, PANCAKE_ROUTER);
        
        const amountInWei = amountToken * (10 ** tokenDecimals);
        const path = [tokenAddress, WBNB];
        
        const amounts = await router.methods.getAmountsOut(amountInWei.toString(), path).call();
        const output = amounts[1] / (10 ** 18); // BNB has 18 decimals
        
        return output;
    } catch (error) {
        console.error("Token to BNB estimation error:", error);
        throw new Error("Qadarka lagu estimate gareyn karo waa khalad");
    }
}

async function estimateTokenToToken(amountToken, fromTokenAddress, toTokenAddress, fromTokenDecimals) {
    try {
        const router = new web3.eth.Contract(PANCAKESWAP_ROUTER_ABI, PANCAKE_ROUTER);
        
        const amountInWei = amountToken * (10 ** fromTokenDecimals);
        const path = [fromTokenAddress, WBNB, toTokenAddress];
        
        const amounts = await router.methods.getAmountsOut(amountInWei.toString(), path).call();
        const output = amounts[2] / (10 ** 18); // Assuming toToken has 18 decimals
        
        return output;
    } catch (error) {
        console.error("Token to Token estimation error:", error);
        throw new Error("Qadarka lagu estimate gareyn karo waa khalad");
    }
}



// Ku bedel getSigner function si loo isticmaalo web3
async function getSigner() {
    if (currentPrivateKey) {
        // Isticmaal web3-gaaga hore
        const account = web3.eth.accounts.privateKeyToAccount(currentPrivateKey);
        
        // Add account to web3 wallet temporarily
        if (!web3.eth.accounts.wallet[currentAddress]) {
            web3.eth.accounts.wallet.add(currentPrivateKey);
        }
        
        return account;
    }
    throw new Error("Wallet ma furan. Fadlan fur wallet-kaaga marka hore.");
}

// Ku bedel performRealSwap function si uu u isticmaalo web3-ga saxda ah
async function performRealSwap(amount, fromToken, toToken, slippagePercent) {
    const router = new web3.eth.Contract(PANCAKESWAP_ROUTER_ABI, PANCAKE_ROUTER);
    
    let tx;
    
    if (fromToken.symbol === 'BNB' && toToken.symbol !== 'BNB') {
        // BNB to Token
        tx = await performBNBToTokenSwap(amount, toToken, slippagePercent, router);
    } else if (fromToken.symbol !== 'BNB' && toToken.symbol === 'BNB') {
        // Token to BNB
        tx = await performTokenToBNBSwap(amount, fromToken, slippagePercent, router);
    } else if (fromToken.symbol !== 'BNB' && toToken.symbol !== 'BNB') {
        // Token to Token
        tx = await performTokenToTokenSwap(amount, fromToken, toToken, slippagePercent, router);
    } else {
        throw new Error("Cannot swap BNB to BNB / Ma suurtagalno inaad swap-gareysid BNB -> BNB");
    }

    return tx;
}

// Ku bedel performBNBToTokenSwap si uu u shaqeeyo
async function performBNBToTokenSwap(amountBNB, toToken, slippagePercent, router) {
    // Get current output estimate
    const estimatedOutput = await estimateBNBToToken(amountBNB, toToken.address);
    const minOutput = Number(estimatedOutput) * (1 - slippagePercent / 100);
    const minOutputWei = web3.utils.toWei(minOutput.toString(), 'ether');

    // Set deadline (20 minutes from now)
    const deadline = Math.floor(Date.now() / 1000) + 1200;

    // Perform the swap using web3
    const tx = await router.methods.swapExactETHForTokens(
        minOutputWei,
        [WBNB, toToken.address],
        currentAddress,
        deadline
    ).send({
        from: currentAddress,
        value: web3.utils.toWei(amountBNB.toString(), 'ether'),
        gas: 300000
    });

    return tx;
}

// Ku bedel performTokenToBNBSwap si uu u shaqeeyo
async function performTokenToBNBSwap(amountToken, fromToken, slippagePercent, router) {
    // First, approve the router to spend tokens
    const tokenContract = new web3.eth.Contract(ERC20_ABI, fromToken.address);
    
    // Check current allowance
    const currentAllowance = await tokenContract.methods.allowance(currentAddress, PANCAKE_ROUTER).call();
    const requiredAllowance = web3.utils.toWei(amountToken.toString(), 'ether');
    
    if (Number(currentAllowance) < Number(requiredAllowance)) {
        statusDiv.textContent = "Approving token... / Token-ka la approve-gareynayo...";
        const approveTx = await tokenContract.methods.approve(PANCAKE_ROUTER, requiredAllowance).send({
            from: currentAddress,
            gas: 100000
        });
    }

    // Get current output estimate
    const estimatedOutput = await estimateTokenToBNB(amountToken, fromToken.address, fromToken.decimals);
    const minOutput = Number(estimatedOutput) * (1 - slippagePercent / 100);
    const minOutputWei = web3.utils.toWei(minOutput.toString(), 'ether');

    // Set deadline (20 minutes from now)
    const deadline = Math.floor(Date.now() / 1000) + 1200;

    // Convert token amount to wei considering token decimals
    const amountInWei = amountToken * Math.pow(10, fromToken.decimals);

    // Perform the swap using web3
    const tx = await router.methods.swapExactTokensForETH(
        amountInWei.toString(),
        minOutputWei,
        [fromToken.address, WBNB],
        currentAddress,
        deadline
    ).send({
        from: currentAddress,
        gas: 300000
    });

    return tx;
}

// Ku bedel performTokenToTokenSwap si uu u shaqeeyo
async function performTokenToTokenSwap(amountToken, fromToken, toToken, slippagePercent, router) {
    // First, approve the router to spend tokens
    const tokenContract = new web3.eth.Contract(ERC20_ABI, fromToken.address);
    
    // Check current allowance
    const currentAllowance = await tokenContract.methods.allowance(currentAddress, PANCAKE_ROUTER).call();
    const requiredAllowance = amountToken * Math.pow(10, fromToken.decimals);
    
    if (Number(currentAllowance) < requiredAllowance) {
        statusDiv.textContent = "Approving token... / Token-ka la approve-gareynayo...";
        const approveTx = await tokenContract.methods.approve(PANCAKE_ROUTER, requiredAllowance.toString()).send({
            from: currentAddress,
            gas: 100000
        });
    }

    // Get current output estimate
    const estimatedOutput = await estimateTokenToToken(amountToken, fromToken.address, toToken.address, fromToken.decimals);
    const minOutput = Number(estimatedOutput) * (1 - slippagePercent / 100);
    const minOutputWei = web3.utils.toWei(minOutput.toString(), 'ether');

    // Set deadline (20 minutes from now)
    const deadline = Math.floor(Date.now() / 1000) + 1200;

    // Convert token amount to wei considering token decimals
    const amountInWei = amountToken * Math.pow(10, fromToken.decimals);

    // Perform the swap
    const tx = await router.methods.swapExactTokensForTokens(
        amountInWei.toString(),
        minOutputWei,
        [fromToken.address, WBNB, toToken.address],
        currentAddress,
        deadline
    ).send({
        from: currentAddress,
        gas: 300000
    });

    return tx;
}

     
  // Swap button event listener
  swapBtn.addEventListener('click', async () => {
    try {
      const amount = parseFloat(fromAmountInput.value);
      if (!amount || amount <= 0) {
        statusDiv.textContent = "Please enter a valid amount";
        statusDiv.style.color = "red";
        return;
      }

      if (fromToken.symbol === toToken.symbol) {
        statusDiv.textContent = "Cannot swap the same token";
        statusDiv.style.color = "red";
        return;
      }

      const fromBalance = parseFloat(fromBalanceEl.textContent);
      if (amount > fromBalance) {
        statusDiv.textContent = "Insufficient balance";
        statusDiv.style.color = "red";
        return;
      }

      statusDiv.textContent = "ðŸ”ƒ Preparing...";
      statusDiv.style.color = "#4a6cf7";
      swapBtn.disabled = true;

      const slippage = parseFloat(slippageInput.value) || 2;
      statusDiv.textContent = "ðŸ”„ Sending transaction...";
      
      const tx = await performRealSwap(amount, fromToken, toToken, slippage);
      
      statusDiv.textContent = `âœ… Transaction sent: ${tx.transactionHash}`;
      statusDiv.style.color = "green";
      
      statusDiv.textContent = `ðŸŽ‰ SWAP SUCCESSFUL! ${amount} ${fromToken.symbol} â†’ ${toToken.symbol}`;
      
      await updateBalances();
      fromAmountInput.value = '';
      toAmountInput.value = '';

      pushTxHistory({ 
        type: `Swap ${fromToken.symbol} to ${toToken.symbol}`, 
        to: 'PancakeSwap', 
        amount: amount, 
        txHash: tx.transactionHash, 
        ts: Date.now() 
      });

    } catch (error) {
      console.error("Swap error:", error);
      let errorMessage = error.message || "An error occurred";
      
      if (errorMessage.includes("user rejected") || errorMessage.includes("denied transaction")) {
        errorMessage = "User rejected the transaction";
      } else if (errorMessage.includes("insufficient funds")) {
        errorMessage = "Insufficient funds";
      } else if (errorMessage.includes("MIN_OUTPUT")) {
        errorMessage = "Slippage too high";
      }
      
      statusDiv.textContent = `âŒ Error: ${errorMessage}`;
      statusDiv.style.color = "red";
    } finally {
      swapBtn.disabled = false;
    }
  });

  
// Kadib ku dar CSS cusub
    const additionalStyles = `
.token-option {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
}

.token-option:hover {
    background: #f0f4ff;
}

.token-info {
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
}

.token-balance-info {
    text-align: right;
}

.token-balance {
    font-size: 12px;
    color: #666;
    font-weight: 600;
}

.token-usd-value {
    font-size: 10px;
    color: #999;
}

.balance-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 4px;
}

.balance-actions {
    display: flex;
    gap: 8px;
}

.balance-action-btn {
    background: #f0f4ff;
    border: none;
    border-radius: 4px;
    padding: 2px 6px;
    font-size: 10px;
    color: #4a6cf7;
    cursor: pointer;
    transition: all 0.3s;
}

.balance-action-btn:hover {
    background: #4a6cf7;
    color: white;
}
`;

  // Add styles for the trade screen
  const style = document.createElement('style');
  style.textContent = `
    .trade-screen {
      width: 100%;
      max-width: 480px;
      background: #fff;
      border-radius: 18px;
      margin: 20px auto;
      padding: 20px;
      display: block;
      position: relative;
      z-index: 1000;
    }
    
    .swap-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .swap-input label {
      font-weight: 600;
      margin-bottom: 8px;
      display: block;
      color: #333;
    }
    
    .input-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .input-group input {
      flex: 1;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.3s;
    }
    
    .input-group input:focus {
      border-color: #4a6cf7;
      outline: none;
      box-shadow: 0 0 0 3px rgba(74, 108, 247, 0.2);
    }
    
    .input-group select {
      width: 100px;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 10px;
      background: #fff;
      cursor: pointer;
    }
    
    .balance-info {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
      text-align: right;
    }
    
    .swap-btn {
      padding: 15px;
      background: #4a6cf7;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
      width: 100%;
    }
    
    .swap-btn:hover:not(:disabled) {
      background: #3a5ce5;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(58, 92, 229, 0.3);
    }
    
    .swap-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    #swapStatus {
      min-height: 10px;
      text-align: center;
      
      background: #f8f9fa;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  `;
  
  document.head.appendChild(style);

  // Focus on input for better UX
  fromAmountInput.focus();
}

 
// Initialize bottom navigation when page loads
document.addEventListener('DOMContentLoaded', function() {
  console.log("DOM loaded, initializing navigation...");
  initBottomNavigation();
});
  
const homeNav = document.getElementById('homeNavigation');
const iframeContainer = document.getElementById('iframeContainer');

function openInApp(url) {
    // Hide home navigation
    homeNav.style.display = 'none';
    // Show iframe container
    iframeContainer.style.display = 'block';
    // Clear old content
    iframeContainer.innerHTML = '';

    // Create iframe
    const iframe = document.createElement('iframe');
    iframe.src = url;
    iframe.style.width = '100%';
    iframe.style.height = '100%';
    iframe.style.border = 'none';
    iframe.style.borderRadius = '12px';
    iframeContainer.appendChild(iframe);

  // Create small circular back button with ðŸ”™ icon at right center
const backBtn = document.createElement('button');
backBtn.innerHTML = 'ðŸ”™'; // back icon
backBtn.style.position = 'absolute';
backBtn.style.top = '50%'; // vertical center
backBtn.style.right = '20px'; // dhinaca midig
backBtn.style.transform = 'translateY(-50%)'; // si uu u center noqdo
backBtn.style.width = '50px';
backBtn.style.height = '50px';
backBtn.style.borderRadius = '50%';
backBtn.style.border = 'none';
backBtn.style.background = 'linear-gradient(135deg, #1a73e8, #0f204d)'; // blue + dark
backBtn.style.color = '#fff';
backBtn.style.fontSize = '24px';
backBtn.style.cursor = 'pointer';
backBtn.style.boxShadow = '0 4px 10px rgba(0,0,0,0.3)';
backBtn.style.transition = 'transform 0.2s, box-shadow 0.2s';
backBtn.style.zIndex = '1000';

// Hover effect
backBtn.onmouseover = () => {
    backBtn.style.transform = 'translateY(-50%) scale(1.1)';
    backBtn.style.boxShadow = '0 6px 12px rgba(0,0,0,0.4)';
};
backBtn.onmouseout = () => {
    backBtn.style.transform = 'translateY(-50%) scale(1)';
    backBtn.style.boxShadow = '0 4px 10px rgba(0,0,0,0.3)';
};

// Click to go back
backBtn.onclick = () => {
    iframeContainer.style.display = 'none';
    homeNav.style.display = 'flex';
};

iframeContainer.appendChild(backBtn);
}

</script>
</body>
</html>
